# 4. アーキテクチャ検討・設計判断フェーズ（ソフトウェアレベル）

凍結された `docs/requirements/02_system-requirements.md` と `docs/design/00_system-design.md` を出発点に、**ソフトウェアアーキテクチャ候補を洗い出し・比較・評価**し、ADR に流し込むための「判断材料」を構造化するフェーズ。

このフェーズの成果物は `docs/design/01_architecture-evaluation.md` であり、次フェーズ「5. ADR 作成」の唯一の入力となる。

---

## 前提条件

以下のファイルが完了・凍結していること。

- `docs/requirements/01_stakeholder-needs.md`（要求凍結済み）
- `docs/requirements/02_system-requirements.md`（要件凍結済み）
- `docs/design/00_system-design.md`（システム設計凍結済み）
- Open Questions が完全に解消されていること

---

# STEP 1：Architecture Evaluation Draft（初回生成）

## 目標
要件定義のエッセンスを整理し、アーキテクチャ検討のドラフトを作成する。ここでは**候補が粗くてもよいので全体像を固定**することを優先する。

## 事前準備（必ず抜き出す）
1. **主要な機能要件（REQ-F）**  
   - コア機能、外部連携（CSV/API/DB）の有無
2. **重要な非機能要件（REQ-NF）**  
   - Performance / Availability / Maintainability / Security / Scalability など
3. **制約条件（Constraints）**  
   - 技術スタック、運用形態、チームスキル、既存システムとの整合
4. **データフローの前提**  
   - Single Source of Truth、入出力経路、同期タイミング

## 使うコマンド
`.claude/commands/architecture-decision.md`

## Claude への持ち込み例

```claude
/architecture-decision

docs/requirements/02_system-requirements.md を前提に、
アーキテクチャ候補の Draft を生成してください。
```

## Draft の特徴
- 候補案・品質特性・制約が一望できるが、粒度はまだ粗い
- Quality Attributes × Candidate の評価はコメント中心で概算
- リスク／トレードオフは見出しレベルでよい
- 「7. Inputs for ADR」は雛形レベルのラフな記述で十分

## 生成されるファイル
`docs/design/01_architecture-evaluation.md`

テンプレート構造：

```
1. Context        ─ システム概要 / 想定利用シナリオ / 制約 / データフロー
2. Quality Attributes
3. Candidate Architectures
4. Evaluation
5. Recommended Architecture
6. Impact & Risks
7. Inputs for ADR  ─ Problem / Decision / Alternatives / Rationale / Consequences
```

---

# STEP 2：Architecture Evaluation Refine（比較と追記のループ）

## 目標
Draft で浮き彫りになったギャップを埋め、**候補比較を定量化し ADR に直結する粒度**に磨き上げる。

## ループの流れ
1. Draft の「7. Inputs for ADR」と Evaluation マトリクスを読み、足りない観点を洗い出す
2. 追記・修正したい指示をメモ化（品質指標の数値、リスクの補足など）
3. `/architecture-decision <memo>` を再実行して `01_architecture-evaluation.md` を再生成
4. 生成結果をレビューして差分を検証
5. まだ曖昧さが残る場合はメモを更新し、再び 3 に戻る

## Claude への持ち込み例

```claude
/architecture-decision memo_architecture_notes.txt
```

`memo_architecture_notes.txt` の例：
- 候補Bの Single Source of Truth を具体的に（永続層の所在まで）
- QA-002（Performance）に「最大応答 1.5s」「バッチ 5 分以内」を追加
- Impact & Risks に「データ移行コスト」と軽減策を追記

## Refine のチェックポイント
- Quality Attributes が ISO 25010 等の粒度で **定量的な基準**を持つ
- 候補ごとに構成要素・データフロー・採用技術が明示されている
- Evaluation マトリクスのコメントとスコアが一致し、具体的な比較になっている
- 「7. Inputs for ADR」が 1 ADR = 1 決定 の単位に切り出せる粒度に整理されている

---

# STEP 3：Architecture Evaluation Freeze（レビュー＆凍結宣言）

## 目標
`01_architecture-evaluation.md` をレビューし、**ADR 作成の唯一のインプット**として凍結する。

## レビューチェックリスト

### 3.1 候補の妥当性
- [ ] アプリケーション / システムレベルの候補が揃っている
- [ ] **MVC / MVP / MVVM 等の UI パターン単体が候補として独立していない**
- [ ] 各候補の説明が比較できる粒度で揃っている

### 3.2 評価の具体性
- [ ] Quality Attributes が数値・条件で定義されている
- [ ] 評価マトリクスのコメントが抽象論に留まっていない
- [ ] リスクとトレードオフが現実的で、アクションにつながる

### 3.3 推奨案の根拠
- [ ] 推奨アーキテクチャの選定理由が明確
- [ ] チームスキル・運用形態・ロードマップと矛盾しない
- [ ] 将来拡張（スケール、派生プロダクト）への見通しが書かれている

### 3.4 ADR への入力準備
- [ ] Problem / Decision / Alternatives / Rationale / Consequences が揃っている
- [ ] 1 ADR = 1 決定 に切り出せる単位で整理されている

## 修正依頼テンプレート

```claude
docs/design/01_architecture-evaluation.md をレビューしました。
以下の点を修正してください。

- 候補Bの「データフローと Single Source of Truth」が抽象的
- QA-003（Maintainability）の評価コメントが具体性に欠ける
- 「7. Inputs for ADR」の Rationale を 3 行以内に凝縮
```

## 凍結宣言テンプレート

```claude
docs/design/01_architecture-evaluation.md のレビューが完了しました。
内容は妥当で、ADR 作成フェーズに進む準備が整っています。

以降、このファイルを前提として ADR 作成フェーズに進んでください。
```

---

# 全体フロー

```
STEP 1：Architecture Evaluation Draft
  ↓ 02_system-requirements.md から情報を抽出
STEP 2：Architecture Evaluation Refine（ループ）
  ↓ /architecture-decision で再生成・差分吸収
STEP 3：Architecture Evaluation Freeze
  ↓ 凍結宣言 → ADR 作成フェーズへ
```

---

## 重要な注意事項

### UI アーキテクチャの扱い
- MVC / MVP / MVVM などの UI パターンを、アプリケーションアーキテクチャ候補そのものとして列挙しない
- 各候補の中で「プレゼンテーション層の設計方針」として記述する

### 検討と決定の切り分け
- 本フェーズは **検討・比較・評価** を担い、最終決定は ADR で行う
- `01_architecture-evaluation.md` は ADR の入力メモであり、ADR そのものではない

### 要件定義との整合
- `02_system-requirements.md` に存在しない要件を前提にしない
- REQ-F / REQ-NF / STK ID を正確に参照する
- 曖昧さが残る場合は要件定義フェーズに戻って解消する

### 成果物
- `docs/design/01_architecture-evaluation.md`（凍結済み）
  - 次フェーズ「4. ADR 作成」の唯一の入力
