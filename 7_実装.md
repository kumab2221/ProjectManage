# 7. 実装フェーズ

プラン（`plans/feature-*.md`）を前提に、**タスク単位で段階的に実装**を進めるフェーズ。設計書・ADR との整合性を保ちながら、テスト駆動で高品質なコードを生成する。

このプロセスにより、
後続の「テスト → レビュー → デプロイメント」が破綻しない状態をつくる。

---

## 前提条件

以下の成果物が凍結されていること：
- `docs/requirements/02_system-requirements.md`（要件定義）
- `ADR/ADR-XXX-*.md`（Status: Accepted）
- `docs/design/*.md`（設計書）
- `plans/feature-<機能名>.md`（実装プラン）

---

# STEP 1：実装対象の確認

## 目的
プランファイルを読み込み、**実装スコープと依存関係を把握する**。

## 使うコマンド
`.claude/commands/implement-file.md`

## Claude への指示例
```claude
/implement-file

plans/feature-csv-import.md を実装します。
TASK-CSV-001 から順に、TDD で進めてください。
```

## このステップで行われること
1. **プラン構造の検証**
   - Background / Objective / Scope が明確
   - Tasks がタスク ID（`TASK-<略称>-<連番>`）で採番されている
   - 各タスクが 1〜1.5 時間粒度
   - 依存関係が明示されている
   - Acceptance Criteria（受入条件）が測定可能

2. **関連ドキュメントの確認**
   - 設計書（`docs/design/*.md`）で対象クラス・メソッドが定義されている
   - ADR で技術選択が承認されている
   - 要件定義で機能が MUST / SHOULD に分類されている

3. **依存関係の解決**
   - 先行タスクがすべて完了している
   - 外部ライブラリ・環境設定が整っている

## 完了条件
- プランの構造が正しく、実装可能な状態であることを確認
- 設計書・ADR との整合性が保たれている
- 依存関係がすべて解決されている

---

# STEP 2：タスク単位での実装（TDD サイクル）

## 目的
プランの Tasks セクションに記載された**タスク ID 順**に、1 つずつ実装を進める。

## 使うコマンド
`.claude/commands/implement-file.md`（継続）

## 実装サイクル（1 タスクごと）

### 2-1. タスク内容の理解
- タスク ID、タスク名、担当ファイル、依存タスクを確認
- 設計書で該当クラス・メソッドの仕様を再確認
- ADR で技術的制約を確認

### 2-2. テストファーストアプローチ
1. **テストケース作成（Red）**
   - `tests/test_<モジュール名>.py` に pytest テストを作成
   - Acceptance Criteria をテストケースに変換
   - 失敗するテストを先に書く

2. **実装コード作成（Green）**
   - `src/<ファイル>.py` を生成または更新
   - 型アノテーション必須（mypy 対応）
   - docstring でクラス・メソッドの説明を追加
   - テストが通るように実装

3. **リファクタリング（Refactor）**
   - コードの可読性・保守性を向上
   - 重複コードの削減
   - 設計原則（SOLID）の適用

### 2-3. 品質チェック
1. **静的解析**
   ```bash
   ruff check src/ tests/
   mypy src/ tests/
   ```
   - すべてのエラー・警告を解消

2. **テスト実行**
   ```bash
   pytest tests/test_<モジュール名>.py -v
   ```
   - すべてのテストが成功（100% pass）

3. **設計整合性チェック**
   - 設計書で定義されたクラス名・メソッド名と一致しているか
   - ADR で決定した技術・ライブラリを使用しているか
   - Out of Scope（プラン外）の機能を追加していないか

### 2-4. タスク完了の記録
- タスク ID をチェックリストでマーク
- 実装したファイルパスとコミットメッセージを記録
- 次のタスクへ進む

## Claude への指示例（特定タスクから再開）
```claude
/implement-file

plans/feature-chart-display.md の TASK-CHART-003 から再開します。
TASK-CHART-001〜002 は完了済みです。
```

## 完了条件
- すべてのタスク（`TASK-XXX-YYY`）が完了
- ruff / mypy / pytest でエラーなし
- 設計書・ADR との整合性が保たれている

---

# STEP 3：機能全体の統合テスト

## 目的
すべてのタスクが完了したら、**機能全体を統合テストで検証する**。

## 使うコマンド
`.claude/commands/implement-file.md`（品質チェック）

## Claude への指示例
```claude
/implement-file

plans/feature-settings-management.md の実装済みコードを検証してください。
- ruff / mypy / pytest 実行
- Acceptance Criteria の確認
- 設計書との整合性チェック
```

## このステップで行われること
1. **受入条件の確認**
   - プランの Acceptance Criteria をすべてチェック
   - 自動テスト化されていない条件は手動で確認

2. **エンドツーエンドテスト**
   - ユーザーストーリー（要件定義）に沿った動作確認
   - 正常系・異常系の両方をテスト

3. **リグレッションテスト**
   - 既存機能が壊れていないか全テストを実行
   ```bash
   pytest tests/ -v
   ```

## 完了条件
- Acceptance Criteria がすべて満たされている
- E2E テストが成功している
- リグレッションテストでエラーなし

---

# STEP 4：実装完了の宣言

## 目的
プランで定義されたすべてのタスクと受入条件を満たしたことを確認し、**完了を宣言する**。

## Claude への宣言（必須）
```claude
plans/feature-csv-import.md の実装が完了しました。

【実装ファイル】
- src/csv_parser.py
- src/csv_validator.py
- tests/test_csv_parser.py

【品質確認】
- ruff check: OK
- mypy: OK
- pytest: 全テスト成功（15 / 15 passed）

【受入条件】
- ✅ CSV ファイル（UTF-8, Shift-JIS）を正しくパースできる
- ✅ 不正な形式のファイルに対してエラーメッセージを返す
- ✅ 10,000 行のファイルを 3 秒以内に処理できる

次のプラン（plans/feature-chart-display.md）へ進む準備ができています。
```

## 完了チェックリスト
- [ ] すべてのタスク（`TASK-XXX-YYY`）が完了
- [ ] Acceptance Criteria がすべて満たされている
- [ ] ruff / mypy / pytest でエラーなし
- [ ] 設計書・ADR との整合性が保たれている
- [ ] docstring とコメントが適切に記述されている
- [ ] Git コミット済み（適切なコミットメッセージ）

---

# 全体フロー

```
STEP 1：実装対象の確認（/implement-file）
  ↓ プラン・設計書・ADR の検証
  ↓ 依存関係の解決
STEP 2：タスク単位での実装（TDD サイクル）
  ↓ Red → Green → Refactor
  ↓ 品質チェック（ruff / mypy / pytest）
  ↓ タスク完了の記録
STEP 3：機能全体の統合テスト
  ↓ 受入条件確認
  ↓ E2E テスト
  ↓ リグレッションテスト
STEP 4：実装完了の宣言
  ↓ 完了チェックリスト
  ↓ 完了宣言テンプレート
→ テスト・レビュー・デプロイメントフェーズへ
```

---

## コード品質基準

### 必須要件
- **型アノテーション**：すべての関数・メソッドに型ヒントを付与
- **docstring**：クラス・メソッドに説明を記述（Google Style / NumPy Style）
- **命名規則**：PEP 8 に準拠（変数名：snake_case、クラス名：PascalCase）
- **静的解析**：ruff / mypy でエラーなし
- **テストカバレッジ**：主要ロジックは 80% 以上

### 推奨事項
- **単一責任の原則**：1 クラス / 1 メソッドは 1 つの責務のみ
- **依存性注入**：外部依存はコンストラクタで注入
- **不変性**：可能な限り immutable なデータ構造を使用
- **例外処理**：適切なエラーハンドリングとログ出力

---

## リスクと対策

### プランで定義されたリスク
プランの Risks セクションを確認し、Impact / Probability / Mitigation に従って対応する。

### 実装中の一般的なリスク
1. **設計書との不整合**
   - 対策：実装前に設計書を再確認。不明点はチームに質問

2. **テストが書けない**
   - 対策：設計を見直す。テスタビリティを考慮してリファクタリング

3. **タスク粒度が大きすぎる**
   - 対策：タスクをさらに分割。プランを更新

4. **外部依存の問題**
   - 対策：モック・スタブで代替。統合テストは後回し

---

## 注意事項

- **プラン外の機能を追加しない**：Out of Scope に記載されている機能は実装しない
- **設計書を勝手に変更しない**：必要なら設計フェーズへ戻す
- **タスク順序を守る**：依存関係を無視して先に進まない
- **コミットメッセージ**：タスク ID を含める（例：`[TASK-CSV-001] Implement CSV parser`）
- **レビュー前提**：すべてのコードはレビュー可能な状態にする

---

## 成果物

- `src/<モジュール>.py`：実装コード（型アノテーション・docstring 完備）
- `tests/test_<モジュール>.py`：pytest テストコード
- 品質チェックレポート（ruff / mypy / pytest の結果）
- 実装完了宣言（受入条件クリア確認）

これらの成果物が、レビュー・統合テスト・デプロイメントフェーズへの引継ぎ資料となる。
