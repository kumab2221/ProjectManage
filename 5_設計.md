# 5. 設計フェーズ（UI / ドメイン / IF 設計）

要件定義（02_system-requirements.md）と
ADR（Architecture Decision Record）に基づき、
**設計書（UI / Domain / Infrastructure / IF / Module）** を作成するフェーズ。

設計書は「要件 → 設計 → 実装」のエラーなし連動を実現し、
ADR の決定に沿った形で設計の一貫性と変更履歴を保証する。

---

## 前提条件

以下のファイルが完成していること：

- ✅ `docs/requirements/02_system-requirements.md`（要件凍結済み）
- ✅ `ADR/ADR-XXX-*.md`（設計判断記録済み、Status: Accepted）

---

# STEP 1：設計対象の選定

## 目的
要件定義書と ADR を確認し、どの設計書を作成するかを決定する。

## 設計書の種類

以下の種類から、必要なものを選定する：

1. **UI 設計**（`docs/design/01_ui-design.md`）
   - 画面設計、画面遷移、UI コンポーネント
   - ユーザー操作フロー、エラー処理

2. **ドメイン設計**（`docs/design/02_domain-design.md`）
   - ドメインモデル、エンティティ、値オブジェクト
   - ビジネスロジック、ドメインサービス

3. **インフラストラクチャ設計**（`docs/design/03_infrastructure-design.md`）
   - データストア（DB スキーマ、テーブル定義）
   - 外部連携（ファイル I/O、API）

4. **インターフェース設計**（`docs/design/04_interface-design.md`）
   - レイヤ間インターフェース
   - リポジトリ、サービス、ファサード

5. **モジュール設計**（`docs/design/05_module-design.md`）
   - パッケージ構成、依存関係
   - ディレクトリ構造

## 選定の基準

要件定義書の内容に応じて、必要な設計書を選定する：

- **UI を伴うアプリケーション** → UI 設計が必須
- **ビジネスロジックが複雑** → ドメイン設計が必須
- **外部データソースと連携** → インフラストラクチャ設計が必須
- **レイヤードアーキテクチャ採用** → インターフェース設計が推奨
- **大規模プロジェクト** → モジュール設計が推奨

## Claude への指示例（選定確認）

```claude
docs/requirements/02_system-requirements.md と
ADR を確認し、必要な設計書の種類を提案してください。

プロジェクト概要：
- デスクトップアプリ（PySide6）
- CSV インポート機能
- チャート表示機能
- SQLite でデータ管理
```

---

# STEP 2：設計書の生成

## 目的
選定した設計対象について、ADR の決定に沿った設計書を生成する。

## 使うコマンド
`.claude/commands/design-from-requirements.md`（または `Commands/design-from-requirements.md` を参照）

## Claude への指示例

### UI 設計を作成する場合

```claude
/design-from-requirements

docs/requirements/02_system-requirements.md と
ADR ディレクトリ内の全 ADR を参照し、
UI 設計を生成してください。

対象：
- メインウィンドウ（CSV インポート、チャート表示）
- 設定ダイアログ

出力先：docs/design/01_ui-design.md
```

### ドメイン設計を作成する場合

```claude
/design-from-requirements

docs/requirements/02_system-requirements.md と
ADR ディレクトリ内の全 ADR を参照し、
ドメイン設計を生成してください。

対象：
- WorkRecord エンティティ
- ChartService ドメインサービス
- ImportService ドメインサービス

出力先：docs/design/02_domain-design.md
```

### インフラストラクチャ設計を作成する場合

```claude
/design-from-requirements

docs/requirements/02_system-requirements.md と
ADR ディレクトリ内の全 ADR を参照し、
インフラストラクチャ設計を生成してください。

対象：
- SQLite スキーマ定義
- CSV インポート処理
- リポジトリ実装方針

出力先：docs/design/03_infrastructure-design.md
```

## このステップで生成されるファイル

`docs/design/<設計対象>.md`

以下の構造で出力される：

```markdown
# <設計対象名> Design

## 1. Overview（概要）
- 設計対象の目的
- 関連する REQ-ID（機能/非機能）を列挙
- 関連する ADR を列挙

## 2. Architecture Alignment（アーキテクチャ整合性）
- 関連 ADR の要点を要約し、今回の設計への影響を 3〜6 行で記述
- 禁止事項／制約／依存方向（Layered / MVVM / Repository）などを明記
- 02_system-requirements の制約との整合性を明示

## 3. Design Details（詳細設計）

### 3.1 構造（Structure）
- クラス構成図（Mermaid OK）
- レイヤー配置
- 使用するデザインパターン（MVVM、Repository、Service など）

### 3.2 データフロー
- 入力 → 処理 → 出力
- 状態遷移
- 外部要素（CSV, API, DB）との関係

### 3.3 振る舞い（Behavior）
- 主要ユースケースのシーケンス図（Mermaid）
- 例外処理方針
- エラー時の UI / Domain の振る舞い

## 4. Mapping to Requirements（要件への対応）
- 必要な REQ-F / REQ-NF の一覧を表形式で列挙
- どの設計要素がどの要件を満たすかを記述
- 未対応の REQ があれば警告を出す

## 5. Trade-offs（設計上の判断）
- ADR には書ききれないレベルでの詳細判断
- 選択肢 A/B/C とその理由を簡潔に記述
- 今回の設計決定の根拠を明確にする

## 6. Risks & Future Considerations（リスクと将来拡張）
- この設計のリスク（保守性・性能・依存）
- 将来の変更時に影響が出る箇所
- ADR を再評価するべきトリガー

## 7. Appendix
- 補足図
- 詳細メモ
- 必要に応じて仕様参照
```

---

# STEP 3：設計書のレビュー

## 目的
生成された設計書の内容を確認し、
要件との対応・ADR との整合性・実装可能性を検証する。

## レビューポイント

### 3.1 要件との対応
- [ ] すべての REQ-F / REQ-NF が設計要素にマッピングされているか
- [ ] 「4. Mapping to Requirements」が正確か
- [ ] 未対応の REQ がある場合、理由が明確か

### 3.2 ADR との整合性
- [ ] 「2. Architecture Alignment」が ADR の決定と一致しているか
- [ ] レイヤ間の依存方向が ADR の方針に従っているか
- [ ] 設計パターンの選択が ADR の記録と矛盾していないか

### 3.3 設計の具体性
- [ ] クラス構成図が具体的で実装可能なレベルか
- [ ] データフローが明確か
- [ ] シーケンス図が主要ユースケースをカバーしているか

### 3.4 実装への引き継ぎ
- [ ] 実装者が迷わないレベルの詳細度か
- [ ] エラー処理方針が明確か
- [ ] テスト仕様に直結する記述があるか

## レビュー後の対応

### 修正が必要な場合

```claude
docs/design/01_ui-design.md をレビューしました。
以下の点を修正してください：

- REQ-F-003 が設計要素にマッピングされていない
- ADR-002（MVP パターン）との整合性が不明確
- エラー時の UI の振る舞いが抽象的（具体的なメッセージ例を追加）
```

### 問題なければ承認

```claude
docs/design/01_ui-design.md のレビューが完了しました。
内容は妥当で、実装フェーズに進む準備が整いました。

次の設計書（または次フェーズ）に進んでください。
```

---

# STEP 4：設計書の完了宣言

## 目的
設計フェーズの完了を明確にし、
次フェーズ（実装計画）への引き継ぎを行う。

## Claude への宣言（必須）

```claude
以下の設計書が完成しました：

- docs/design/01_ui-design.md
- docs/design/02_domain-design.md
- docs/design/03_infrastructure-design.md

すべての設計書は要件定義と ADR に基づいており、
実装フェーズに進む準備が整いました。

次のフェーズ「6. 実装計画（プラン作成）」に進んでください。
```

---

# 全体フロー（設計フェーズ）

```
STEP 1：設計対象の選定
  ↓（UI / ドメイン / IF / インフラ / モジュール）
STEP 2：設計書の生成（design-from-requirements コマンド）
  ↓（docs/design/*.md 生成）
STEP 3：設計書のレビュー
  ↓（要件対応・ADR 整合性・実装可能性を確認）
STEP 4：設計書の完了宣言
  ↓
→ 次フェーズ「6. 実装計画（プラン作成）」へ
```

---

## 重要な注意事項

### ⚠️ 要件との対応

- **`02_system-requirements.md` に無い機能を勝手に追加しない**
- すべての REQ-F / REQ-NF が設計要素にマッピングされているか確認する
- 未対応の要件がある場合は、要件定義フェーズに戻って解消する

### ⚠️ ADR との整合性

- **ADR 記録と矛盾する設計を生成しない**
- レイヤ間の依存方向（例：Domain → Infrastructure は禁止）を守る
- 設計パターンの選択が ADR の決定と一致しているか確認する

### ⚠️ 設計の粒度

- 設計書は「実装者が迷わないレベル」の詳細度を目指す
- 過度に抽象的な設計は避ける
- クラス名・メソッド名・パラメータは具体的に記述する

### ⚠️ 設計書の一貫性

- 複数の設計書（UI / ドメイン / IF）間で矛盾がないか確認する
- データフローが一貫しているか確認する
- レイヤ間インターフェースが整合しているか確認する

---

## 設計書作成のベストプラクティス

### 図を活用する

- **クラス構成図**：Mermaid classDiagram を使用
- **シーケンス図**：Mermaid sequenceDiagram を使用
- **状態遷移図**：Mermaid stateDiagram を使用

### 具体的な例を示す

- データフローには具体的な値の例を示す
- エラー処理には具体的なメッセージ例を示す
- ユースケースには具体的な操作手順を示す

### テスト仕様を意識する

- 「受入条件」をテストケースに直結する形で記述する
- 境界値・異常系のパターンを明示する
- モックやスタブの方針を記述する

---

## 成果物

このフェーズ完了時点で、以下のファイルが完成している：

- ✅ `docs/design/01_ui-design.md`（必要に応じて）
- ✅ `docs/design/02_domain-design.md`（必要に応じて）
- ✅ `docs/design/03_infrastructure-design.md`（必要に応じて）
- ✅ `docs/design/04_interface-design.md`（必要に応じて）
- ✅ `docs/design/05_module-design.md`（必要に応じて）

これらの設計書は、次フェーズ「6. 実装計画（プラン作成）」で参照され、
実装タスクの分解と見積もりに使用される。

---

## 設計フェーズと実装フェーズの境界

設計フェーズでは **「何を作るか（What）」と「どう作るか（How）」** を定義する。
実装フェーズでは **「具体的なコード（Code）」** を作成する。

設計書は以下の粒度を目指す：

- ✅ クラス名・メソッド名が決まっている
- ✅ データフロー・状態遷移が明確
- ✅ エラー処理方針が定義されている
- ✅ テスト仕様に直結する記述がある
- ❌ 具体的なコード（実装）は書かない
- ❌ ライブラリの詳細な使い方は書かない

実装者は設計書を見て「迷わずコードを書ける」状態を目指す。
