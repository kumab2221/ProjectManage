# 5. 設計フェーズ（UI / Domain / Infrastructure / Interface / Module）

凍結済みの `docs/requirements/02_system-requirements.md` と Accepted な ADR 群を前提に、**実装へ迷いなく橋渡しできる設計書** を作成するフェーズ。設計書は要件 → 設計 → 実装 の一貫性を担保し、ADR に記録した判断の具体化として扱う。

---

## 前提条件

- `docs/requirements/02_system-requirements.md`（要件凍結）
- `ADR/ADR-XXX-*.md`（Status: Accepted）

---

# STEP 1：設計対象の優先順位づけ

## 目標
要件書と ADR を確認し、どの設計書を生成するかを決定する。大規模機能であれば複数の設計書を並行して準備する。

## 設計書の種類
1. **UI 設計**　`docs/design/01_ui-design.md`
2. **ドメイン設計**　`docs/design/02_domain-design.md`
3. **インフラ設計**　`docs/design/03_infrastructure-design.md`
4. **インターフェース設計**　`docs/design/04_interface-design.md`
5. **モジュール設計**　`docs/design/05_module-design.md`

## 選定の基準
- UI を伴うアプリケーション → UI 設計を優先
- 複雑なビジネスルール → ドメイン設計必須
- 外部データ連携 / DB → インフラ設計
- レイヤード or DDD → インターフェース設計
- 大規模構成 → モジュール設計

## Claude への相談例

```claude
docs/requirements/02_system-requirements.md と ADR を確認し、
優先して作成すべき設計書の種類を提案してください。

プロジェクト概要：
- Windows デスクトップアプリ（PySide6）
- CSV インポート機能、チャート表示機能
- SQLite ＋ DDD Lite モノリス
```

---

# STEP 2：設計書 Draft 生成（/design-from-requirements）

## 目標
選定した設計対象について、ADR の判断に沿った設計書 Draft を生成する。Draft では全体構造を優先し、詳細は後続の Refine で詰める。

## 使うコマンド
`.claude/commands/design-from-requirements.md`

## 入力に含めるべき情報
- 対象となる画面 / ドメインオブジェクト / インターフェース
- 参照すべき ADR 番号
- 出力先ファイル（例：`docs/design/02_domain-design.md`）

## Claude への持ち込み例（UI 設計）

```claude
/design-from-requirements

docs/requirements/02_system-requirements.md と
ADR ディレクトリ内の全 ADR を参照し、
UI 設計書 Draft を生成してください。

対象：
- メインウィンドウ（CSV インポート / チャート表示）
- 設定ダイアログ

出力：docs/design/01_ui-design.md
```

## Draft の特徴
- 画面構成 / 画面遷移 / 状態遷移 / API 一覧などの枠組みが埋まる
- ドメインモデル / ER / コンポーネント図は雛形レベル
- エラー処理・受入条件は見出しのみでも可

---

# STEP 3：設計書 Refine（レビュー＆差分吸収）

## 目標
Draft をレビューし、実装に直結する粒度まで磨き込む。**レイヤー間の依存、トレーサビリティ、テスト容易性**が担保されていることを確認する。

## レビューチェックリスト
- [ ] すべての REQ-F / REQ-NF がどこかの設計要素に紐付く
- [ ] ADR の Decision と矛盾する設計が存在しない
- [ ] クラス / メソッド / API 名が具体的に記載されている
- [ ] データフロー・状態遷移・インターフェースの図（Mermaid 等）が揃っている
- [ ] エラー処理・異常系・受入条件がテスト観点まで落ちている

## 修正依頼テンプレート

```claude
docs/design/02_domain-design.md をレビューしました。
以下の点を修正してください。

- WorkRecord エンティティに Validation ルールを追記
- ImportService の異常系シーケンス図を追加
- テスト方針を BDD シナリオ形式で 3 ケース追記
```

## ベストプラクティス
- Mermaid の `classDiagram / sequenceDiagram / stateDiagram` を活用
- 受入条件はチェックリスト化し、テストケースに直結させる
- モジュール / レイヤ間の依存を矢印で明記する

---

# STEP 4：設計書 Freeze（完了宣言）

## 目標
レビューを完了した設計書を凍結し、実装計画（6. プラン作成）へ引き継ぐ。

## 完了宣言テンプレート

```claude
以下の設計書が完了しました。

- docs/design/01_ui-design.md
- docs/design/02_domain-design.md
- docs/design/03_infrastructure-design.md

すべて要件定義と ADR に整合しており、
実装プラン作成フェーズに進む準備が整いました。
```

---

# 全体フロー

```
STEP 1：設計対象の優先順位づけ
  ↓ 要件・ADR を読み、対象を決定
STEP 2：設計書 Draft 生成（/design-from-requirements）
  ↓ docs/design/*.md を出力
STEP 3：設計書 Refine（レビュー・差分吸収）
  ↓ 実装粒度まで磨き込む
STEP 4：設計書 Freeze（完了宣言）
  ↓ 6. プラン作成へ引き継ぎ
```

---

## 注意事項

- `02_system-requirements.md` にない要件を追加しない。未対応要件は要件フェーズへ差し戻す
- ADR の依存方向（例：Presentation → Application → Domain → Infrastructure）を堅守
- 設計書どうしの整合性（用語、データフロー、例外処理）を常に確認
- コード断片は最小限。設計書は「実装の指示書」であって「ソースコード」ではない

---

## 成果物

- `docs/design/02_ui-design.md`（必要に応じて）
- `docs/design/03_domain-design.md`
- `docs/design/04_infrastructure-design.md`
- `docs/design/05_interface-design.md`
- `docs/design/06_module-design.md`

これらが次フェーズ「6. プラン作成」の入力となる。
