# 実装計画（プラン）作成コマンド

対象機能の実装タスクを分解し、
**実装可能な粒度のタスク一覧とスケジュール** を生成する。

このコマンドは、設計書（docs/design/*.md）を前提に、
実装者が迷わず作業を進められるレベルの実装計画を作成する。

---

## 目的

- docs/design/*.md（設計書）と ADR を参照し、
  1 つの **機能につき 1 つの実装計画ファイル** を作成する。
- タスクを **1〜2 時間粒度** に分解し、実装の進捗管理を可能にする。
- 依存関係・リスクを明確化し、手戻りを防止する。

---

## 入力

以下のファイルを前提とすること：

- `docs/requirements/02_system-requirements.md`（要件定義書）
- `docs/design/*.md`（設計書：UI / ドメイン / インフラ / IF）
- `ADR/*.md`（設計判断記録）

追加で、ユーザーから以下のような補足を受け取ってもよい：

- 対象機能の名称（例：CSV インポート機能、チャート表示機能）
- 優先度（MUST / SHOULD / COULD）
- 想定工数（概算）

入力例：

```
対象機能：CSV インポート機能
優先度：MUST
関連設計書：docs/design/03_infrastructure-design.md
```

---

## 出力ポリシー

1. **1 プラン = 1 機能** とすること。
2. 機能が大きい場合：
   - まず「機能の分割方針」を整理して見せる
   - それぞれを **別ファイル**（feature-<機能名>.md）として生成する
3. 各プランは、**実装者が迷わないレベル** の詳細度を目指す。

---

## ファイル命名規則

- 保存先： `plans/` ディレクトリ配下
- 形式： `feature-<機能名>.md`
  - 例：`feature-csv-import.md`
  - 例：`feature-chart-display.md`
- 機能名は **小文字 + ハイフン** で記述（スネークケース不可）
- 既存プランがある場合：
  - 同名ファイルの上書きは避け、バージョン番号を付ける（例：`feature-csv-import-v2.md`）

---

## プランテンプレ（固定フォーマット）

**見出し構造は絶対に変更してはならない。**

```markdown
# Feature Plan: <機能名>

## 1. Background（背景）

### 1.1 概要
- この機能が必要になった背景（1〜3 行）
- 関連する要求・要件（STK / REQ-ID を列挙）

### 1.2 関連ドキュメント
- docs/requirements/02_system-requirements.md（該当セクション）
- docs/design/*.md（関連設計書）
- ADR/*.md（関連 ADR）

---

## 2. Objective（目的）

この機能の実装により達成すべき目標を **明確に** 記述する。

- ユーザー視点での価値（例：CSV ファイルからデータを簡単にインポートできる）
- システム視点での価値（例：データの一貫性を保証する）
- 非機能要件の達成（例：インポート処理が 10 秒以内に完了する）

---

## 3. Scope（スコープ）

### 3.1 In Scope（含む）
この実装計画で **実装する** 機能・タスクを列挙する。

- 機能 A
- 機能 B
- 機能 C

### 3.2 Out of Scope（含まない）
この実装計画で **実装しない** 機能・タスクを明示する。

- 機能 X（理由：優先度が低い）
- 機能 Y（理由：別プランで対応）
- 機能 Z（理由：要件定義に含まれていない）

---

## 4. Tasks（タスク一覧）

実装タスクを **1〜2 時間粒度** に分解し、以下の形式で列挙する。

### タスクの記述形式

各タスクは以下の情報を含むこと：

- **タスク ID**：`TASK-<機能略称>-<連番>`（例：`TASK-CSV-001`）
- **タスク名**：具体的な作業内容（例：「CSV パーサーのクラス実装」）
- **説明**：タスクの詳細（1〜3 行）
- **担当レイヤ**：Presentation / Application / Domain / Infrastructure
- **見積もり**：作業時間（例：1.5h）
- **依存**：先行タスク ID（例：`TASK-CSV-002` → `TASK-CSV-001` 完了後）
- **成果物**：このタスクで生成されるファイル（例：`src/infrastructure/csv_parser.py`）

### 4.1 基盤タスク（Infrastructure / Domain）

| ID | タスク名 | 説明 | レイヤ | 見積 | 依存 | 成果物 |
|----|---------|------|--------|------|------|--------|
| TASK-CSV-001 | CSV パーサーのインターフェース定義 | CSV ファイルを読み込むインターフェースを定義 | Domain | 0.5h | - | `src/domain/interfaces/csv_reader.py` |
| TASK-CSV-002 | CSV パーサーの実装 | CSV ファイルをパースし、データモデルに変換 | Infrastructure | 1.5h | TASK-CSV-001 | `src/infrastructure/csv_parser.py` |
| ... | ... | ... | ... | ... | ... | ... |

### 4.2 アプリケーションタスク（Application）

| ID | タスク名 | 説明 | レイヤ | 見積 | 依存 | 成果物 |
|----|---------|------|--------|------|------|--------|
| TASK-CSV-005 | インポートサービスの実装 | CSV インポート処理のビジネスロジック | Application | 2.0h | TASK-CSV-002 | `src/application/import_service.py` |
| ... | ... | ... | ... | ... | ... | ... |

### 4.3 プレゼンテーションタスク（Presentation）

| ID | タスク名 | 説明 | レイヤ | 見積 | 依存 | 成果物 |
|----|---------|------|--------|------|------|--------|
| TASK-CSV-008 | インポート UI の実装 | CSV インポートボタンとダイアログの実装 | Presentation | 1.5h | TASK-CSV-005 | `src/presentation/import_dialog.py` |
| ... | ... | ... | ... | ... | ... | ... |

### 4.4 テストタスク（Testing）

| ID | タスク名 | 説明 | レイヤ | 見積 | 依存 | 成果物 |
|----|---------|------|--------|------|------|--------|
| TASK-CSV-010 | CSV パーサーの単体テスト | 正常系・異常系のテストケース作成 | Infrastructure | 1.0h | TASK-CSV-002 | `tests/infrastructure/test_csv_parser.py` |
| ... | ... | ... | ... | ... | ... | ... |

---

## 5. Estimation（見積もり）

### 5.1 タスク別見積もり

| カテゴリ | タスク数 | 合計工数 |
|----------|---------|---------|
| Infrastructure / Domain | 4 | 5.0h |
| Application | 3 | 4.5h |
| Presentation | 2 | 3.0h |
| Testing | 4 | 4.0h |
| **合計** | **13** | **16.5h** |

### 5.2 スケジュール目安

- **開発期間**：3〜4 日（1 日 4〜5 時間作業想定）
- **マイルストーン**：
  - Day 1：基盤タスク完了（CSV パーサー実装）
  - Day 2：アプリケーション層完了（インポートサービス実装）
  - Day 3：プレゼンテーション層完了（UI 実装）
  - Day 4：テスト完了・統合確認

---

## 6. Dependencies（依存関係）

### 6.1 外部依存

このプランの実装に必要な外部要素を列挙する。

- **ライブラリ**：`pandas`（CSV パース用）、`pytest`（テスト用）
- **ファイル**：サンプル CSV ファイル（テスト用）
- **環境**：Python 3.10+、SQLite

### 6.2 内部依存

他のプラン・機能との依存関係を明示する。

- **依存先**：`feature-database-setup.md`（DB テーブル作成が完了していること）
- **依存元**：`feature-chart-display.md`（CSV インポート後にチャート表示が可能になる）

---

## 7. Risks（リスク/懸念点）

実装時に想定されるリスクと、その軽減策を記述する。

### 7.1 技術的リスク

| リスク | 影響度 | 軽減策 |
|--------|--------|--------|
| CSV ファイルのエンコーディングが不明 | 中 | エンコーディング自動判定ライブラリ（chardet）を使用 |
| 大容量 CSV（10万行以上）の処理時間 | 高 | チャンク読み込み＋進捗表示を実装 |
| ... | ... | ... |

### 7.2 仕様的リスク

| リスク | 影響度 | 軽減策 |
|--------|--------|--------|
| CSV フォーマットのバリエーション | 中 | サンプルファイルを複数パターン用意してテスト |
| インポート失敗時のロールバック方針が不明確 | 高 | 要件定義フェーズに戻って確認 |
| ... | ... | ... |

---

## 8. Deliverables（成果物）

このプラン完了時点で生成されるファイル一覧。

### 8.1 実装ファイル

- `src/domain/interfaces/csv_reader.py`
- `src/infrastructure/csv_parser.py`
- `src/application/import_service.py`
- `src/presentation/import_dialog.py`

### 8.2 テストファイル

- `tests/infrastructure/test_csv_parser.py`
- `tests/application/test_import_service.py`
- `tests/presentation/test_import_dialog.py`

### 8.3 ドキュメント

- `docs/implementation/csv-import-spec.md`（実装仕様書）
- サンプル CSV ファイル（`tests/fixtures/sample.csv`）

---

## 9. Acceptance Criteria（受入条件）

このプランが「完了」と判断される条件を明確に記述する。

- [ ] すべてのタスクが完了している
- [ ] 単体テストがすべて成功している（カバレッジ 80% 以上）
- [ ] 統合テストで CSV インポート〜DB 保存〜チャート表示が正常動作する
- [ ] エラー処理（ファイル未選択、フォーマット不正、エンコーディング不正）が実装されている
- [ ] コードレビューが完了している（ruff / mypy エラーなし）
- [ ] ドキュメント（実装仕様書）が更新されている

---

## 10. Notes（備考）

実装時の注意事項や参考情報を記載する。

- CSV パーサーは `pandas.read_csv()` を使用するが、エラー処理は独自実装する
- UI は PySide6 の `QFileDialog` を使用する
- インポート処理は **別スレッドで実行** し、UI をフリーズさせない（ADR-002 の方針に従う）
```

---

## 生成ルール（重要）

1. **1 プラン = 1 機能**
   - 「CSV インポート」「チャート表示」「設定管理」などは、それぞれ別プランに分ける。
   - 1 つのプランに複数の大きな機能をまとめないこと。

2. **タスク粒度を守る**
   - 各タスクは **1〜2 時間** で完了する粒度に分解する。
   - 「CSV インポート機能の実装（8h）」のような粗いタスクは NG。
   - 「CSV パーサーのクラス実装（1.5h）」のような具体的なタスクに分解する。

3. **docs/design との整合性を必ず確認する**
   - docs/design/*.md に存在しない機能を勝手に追加しない。
   - 設計書に記載されたクラス名・メソッド名を正確に使用する。
   - ADR の決定（例：レイヤ間の依存方向）を遵守する。

4. **依存関係を明確にする**
   - 先行タスクが完了しないと着手できないタスクは、「依存」列で明示する。
   - 外部依存（ライブラリ、ファイル、環境）を「6. Dependencies」で明示する。

5. **リスクを具体的に記述する**
   - 「実装が難しい」のような抽象的なリスクは NG。
   - 「大容量 CSV（10万行以上）の処理時間」のような具体的なリスクを記述する。

6. **受入条件を明確にする**
   - 「9. Acceptance Criteria」は **チェックリスト形式** で記述する。
   - 曖昧な条件（「品質が良い」）は避け、具体的な条件（「カバレッジ 80% 以上」）を記述する。

---

## 禁止事項

- 1 つのプランに、複数の大きな機能を詰め込むこと
- 見出し構造の追加・削除・並べ替え
- タスク粒度が粗すぎる（3 時間以上）、または細かすぎる（15 分未満）
- 設計書に存在しないクラス・メソッドを勝手に追加すること
- 依存関係を記述しないこと
- リスクを「特になし」で済ませること
- 受入条件が抽象的・曖昧なこと

---

## 補足：タスク分解のベストプラクティス

### レイヤごとに分解する

1. **Domain / Infrastructure**（基盤）
   - インターフェース定義
   - データモデル定義
   - リポジトリ実装
   - 外部連携実装

2. **Application**（ビジネスロジック）
   - サービス実装
   - ユースケース実装
   - バリデーション実装

3. **Presentation**（UI）
   - 画面実装
   - コントローラ実装
   - ViewModel 実装

4. **Testing**（テスト）
   - 単体テスト
   - 統合テスト
   - E2E テスト

### 見積もりの目安

- インターフェース定義：0.5〜1h
- クラス実装（小）：1〜2h
- クラス実装（中）：2〜4h
- UI 実装（画面 1 つ）：1.5〜3h
- 単体テスト（1 クラス）：0.5〜1.5h
- 統合テスト（1 ユースケース）：1〜2h
