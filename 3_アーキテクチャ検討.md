# 3. アーキテクチャ検討・設計判断フェーズ

凍結された要件定義（02_system-requirements.md）を前提に、
**システム／アプリケーション全体のアーキテクチャ候補**を洗い出し・比較・評価し、
ADR 作成のための「判断材料」を構造化するフェーズ。

このフェーズの成果物（01_architecture-evaluation.md）は、
次フェーズ「4. ADR 作成」の入力として使用される。

---

## 前提条件

以下のファイルが完成・凍結されていること：

- ✅ `docs/requirements/01_stakeholder-needs.md`（要求凍結済み）
- ✅ `docs/requirements/02_system-requirements.md`（要件凍結済み）
- ✅ Open Questions が完全解消されていること

---

# STEP 1：アーキテクチャ検討の準備

## 目的
要件定義書を読み込み、アーキテクチャ検討に必要な情報を整理する。

## 確認事項

以下の情報を `02_system-requirements.md` から抽出しておく：

1. **主要な機能要件（REQ-F）**
   - システムが実現すべきコア機能
   - 外部連携の有無（CSV / API / DB）

2. **重要な非機能要件（REQ-NF）**
   - Performance（応答時間、処理時間）
   - Availability（稼働率、復旧時間）
   - Maintainability（保守性、変更容易性）
   - Security（認証、認可、暗号化）
   - Scalability（将来の拡張性）

3. **制約条件（Constraints）**
   - 技術スタック（言語、FW、DB、インフラ）
   - 運用形態（オンプレ / クラウド / ローカル実行）
   - チームスキル、既存システムとの整合性

4. **データフローの前提**
   - Single Source of Truth の所在
   - データの入出力経路

---

# STEP 2：アーキテクチャ検討の実行

## 目的
要件定義書を前提に、複数のアーキテクチャ候補を洗い出し、
品質特性（QA）との適合度を評価し、推奨案を選定する。

## 使うコマンド
`.claude/commands/architecture-decision.md`（または `Commands/architecture-decision.md` を参照）

## Claude への指示例

```claude
/architecture-decision

docs/requirements/02_system-requirements.md を前提に、
アーキテクチャ候補を検討してください。

補足情報：
- 技術スタック：Python / PySide6 / SQLite
- 運用形態：ローカル実行（Windows デスクトップアプリ）
- チームスキル：Python 中級、DDD 経験なし
- 将来の拡張：現時点では想定なし（要件凍結）
```

## このステップで生成されるファイル

`docs/design/01_architecture-evaluation.md`

以下の構造で出力される：

```
# 01. Architecture Evaluation

## 1. Context（文脈）
- システムの概要
- 想定される利用シナリオ
- 技術・組織・運用上の制約
- データフローの前提

## 2. Quality Attributes（品質特性）
- 重視すべき品質特性の定義
- 数値基準の明確化
- 関連する REQ-NF との紐付け

## 3. Candidate Architectures（候補アーキテクチャ）
- 候補 A：レイヤードアーキテクチャ
- 候補 B：DDD Lite モノリス
- 候補 C：（必要に応じて）

各候補について：
- 概要
- 主な構成要素（レイヤ構造）
- 技術スタック
- データフローと Single Source of Truth

## 4. Evaluation（評価）
- Quality Attributes × Candidate マトリクス
- リスクとトレードオフ

## 5. Recommended Architecture（推奨アーキテクチャ）
- 採用するアーキテクチャ
- 選択しなかった候補と理由

## 6. Impact & Risks（影響とリスク）
- 開発コストへの影響
- 運用コストへの影響
- 組織・プロセスへの影響
- 技術的負債になりうるポイント

## 7. Inputs for ADR（ADR 作成のための要約）
- Problem（問題）
- Decision（決定）
- Alternatives（代替案）
- Rationale（根拠）
- Consequences（結果・影響）
```

---

# STEP 3：アーキテクチャ評価のレビュー

## 目的
生成された `01_architecture-evaluation.md` の内容を確認し、
評価の妥当性と ADR への入力準備が整っているかを検証する。

## レビューポイント

### 3.1 候補の妥当性
- [ ] アーキテクチャ候補が適切に選定されているか
- [ ] **UI パターン（MVC/MVP/MVVM）がアプリケーションアーキテクチャ候補として誤って並べられていないか**
- [ ] 各候補の説明が具体的で理解可能か

### 3.2 評価の具体性
- [ ] Quality Attributes が数値基準を含んでいるか
- [ ] 評価マトリクスのコメントが具体的か（抽象的な評価ではないか）
- [ ] リスクとトレードオフが現実的か

### 3.3 推奨案の根拠
- [ ] 推奨アーキテクチャの選定理由が明確か
- [ ] チームスキル・運用形態との整合性が取れているか
- [ ] 将来の拡張シナリオへの見通しが書かれているか

### 3.4 ADR への入力準備
- [ ] 「7. Inputs for ADR」が簡潔にまとまっているか
- [ ] Problem / Decision / Alternatives / Rationale / Consequences が揃っているか

## レビュー後の対応

### 不足や曖昧な点がある場合

```claude
docs/design/01_architecture-evaluation.md をレビューしました。
以下の点を修正してください：

- 候補 B の「データフローと Single Source of Truth」が抽象的
- QA-003（Maintainability）の評価コメントが具体性に欠ける
- 「7. Inputs for ADR」の Rationale が長すぎる（3〜5 行に凝縮）
```

### 問題なければ次フェーズへ

```claude
docs/design/01_architecture-evaluation.md のレビューが完了しました。
内容は妥当で、ADR 作成フェーズに進む準備が整いました。

次のフェーズ「4. ADR 作成」に進んでください。
```

---

# STEP 4：アーキテクチャ検討の完了宣言

## 目的
アーキテクチャ検討フェーズの完了を明確にし、
次フェーズ（ADR 作成）への引き継ぎを行う。

## Claude への宣言（必須）

```claude
docs/design/01_architecture-evaluation.md は完成しました。
アーキテクチャ候補の検討・評価・推奨案の選定が完了しています。

以降、このファイルの内容を前提として、
ADR 作成フェーズに進んでください。
```

---

# 全体フロー（アーキテクチャ検討フェーズ）

```
STEP 1：アーキテクチャ検討の準備
  ↓（02_system-requirements.md から情報を抽出）
STEP 2：アーキテクチャ検討の実行（architecture-decision コマンド）
  ↓（01_architecture-evaluation.md 生成）
STEP 3：アーキテクチャ評価のレビュー
  ↓（妥当性・具体性・根拠・ADR 入力準備を確認）
STEP 4：アーキテクチャ検討の完了宣言
  ↓
→ 次フェーズ「4. ADR 作成」へ
```

---

## 重要な注意事項

### ⚠️ UI アーキテクチャの扱い

- **MVC / MVP / MVVM などの UI パターンを、アプリケーションアーキテクチャ候補そのものとして並べてはならない**
- UI パターンは、各候補の中の「プレゼンテーション層の設計方針」として記述する
- 例：「Candidate A の Presentation 層は PySide6 + MVP を採用」

### ⚠️ 検討と決定の分離

- このフェーズは **「考えるフェーズ（検討・比較・評価）」** である
- **最終決定は ADR で行う** ため、ここでは「判断材料」を構造化するにとどめる
- `01_architecture-evaluation.md` は ADR の入力資料であり、ADR そのものではない

### ⚠️ 要件定義との整合性

- `02_system-requirements.md` に存在しない要件を勝手に前提にしない
- REQ-F / REQ-NF の ID を正確に参照する
- 曖昧な部分があれば、要件定義フェーズに戻って解消する

---

## 成果物

このフェーズ完了時点で、以下のファイルが完成している：

- ✅ `docs/design/01_architecture-evaluation.md`

このファイルは、次フェーズ「4. ADR 作成」の入力として使用される。
