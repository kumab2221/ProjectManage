# 02. System Requirements

## 1. Overview
本システム（Profit Trace）は、複数プロジェクトの工数消化状況を日次で可視化し、チームリーダーおよびチームメンバー、経営層・プロジェクトマネージャーが進捗およびメンバー稼働状況を判断可能にするデスクトップアプリケーションである。外部サービスから取得した工数実績データ（CSV）とプロジェクト契約情報（CSV）、休日マスタ（JSON）をもとに、バーンダウンチャート形式での工数消化可視化、個人ごとの稼働状況可視化、工数余剰要因の分析支援を提供する。

本システムは Python (uv) 環境で動作し、各ローカル PC で単独実行される。データ更新頻度は日次であり、マルチユーザー同時接続機能は不要である。

## 2. Definitions

| Term | Definition | Related Requirements |
|------|------------|----------------------|
| プロジェクト契約情報 | 業務開始日・終了日・契約工数を含むプロジェクトの契約データ（CSV 形式で提供） | STK-002 |
| 工数実績データ | 外部サービスから取得した、誰がいつどのプロジェクトにどれだけ工数を使用したかを記録したデータ（CSV 形式、単位: 時間 Hour、小数点以下 2 桁） | STK-003 |
| バーンダウンチャート | 横軸を営業日ベースの残日数、縦軸を残工数として、理想線と実績線を比較する進捗可視化手法 | STK-004 |
| 営業日カレンダー | お盆・正月などの長期休暇を考慮した休日マスタ（JSON 形式、休日 = 0、業務日 = 1） | STK-005 |
| 工数消化率 | プロジェクトごとの契約工数に対する消化済み工数の割合 | STK-001 |
| 工数余剰 | 計画よりも工数消化が遅れている状態 | STK-006, STK-007 |
| 理想線 | 契約工数を業務期間で均等消化した場合の工数減少曲線 | STK-004 |
| 実績線 | 実際の工数消化状況を示す曲線 | STK-004 |

## 3. Functional Requirements

### 3.1 構成方針
- ステークホルダー要求（STK-xxx）から導出される機能要件を **REQ-F-XXX（機能 ID）** 形式で記述する。
- 各要件は **受入条件** を必ず持つ。
- 必ず **関連するステークホルダー要求（STK-xxx）** と紐付ける。
- 曖昧・不足・矛盾がある場合は「6. Open Questions」で指摘し、埋めようとしない。

### 3.2 要件一覧

#### REQ-F-001: プロジェクト契約情報の CSV インポート
**概要**
プロジェクト契約情報 CSV ファイルを読み込み、プロジェクトごとの業務開始日・終了日・契約工数を管理する。

**詳細**
- 入力: CSV ファイル（フォーマット: `プロジェクト,開始日,終了日,工数`）
- 出力: プロジェクト契約情報のデータモデルへの格納
- 処理:
  - CSV ファイルをアップロードまたは指定パスから読み込む
  - フォーマットバリデーション（必須項目、日付形式、工数数値の妥当性）
  - プロジェクト名の重複チェック
  - データベース / データストアへの格納
- 例外処理:
  - 不正フォーマット検出時はエラーメッセージを表示し、取り込みを中止
  - 重複プロジェクト名がある場合は警告表示

**受入条件**
- CSV ファイル（フォーマット: `プロジェクト,開始日,終了日,工数`）を読み込み可能であること
- 不正フォーマット（必須項目欠落、日付形式不正、工数が数値でない）を検出し、エラーメッセージを表示すること
- プロジェクト名の重複を検出し、警告表示すること
- 正常なデータのみをデータストアに格納すること

**関連要求**
- STK-002

**備考**
- 日付フォーマットは `YYYY/MM/DD` のみ対応

#### REQ-F-002: 工数実績データの CSV インポート
**概要**
外部サービスから取得した工数実績 CSV ファイルを読み込み、プロジェクトごとに集計する。

**詳細**
- 入力: CSV ファイル（フォーマット: `日付,工数(h),名前,プロジェクト,備考`）
- 出力: 工数実績データのデータモデルへの格納、プロジェクトごとの集計結果
- 処理:
  - CSV ファイルをアップロードまたは指定パスから読み込む
  - フォーマットバリデーション（必須項目、日付形式、工数数値の妥当性、小数点以下 2 桁）
  - プロジェクト名による契約情報とのマッピング
  - 未登録プロジェクトの検出
  - プロジェクトごとの工数集計
- 例外処理:
  - 不正フォーマット検出時はエラーメッセージを表示し、該当行をスキップまたは取り込みを中止
  - 未登録プロジェクトがある場合は警告表示し、該当データをスキップ

**受入条件**
- CSV ファイル（フォーマット: `日付,工数(h),名前,プロジェクト,備考`）を読み込み可能であること
- 工数を時間（Hour）単位、小数点以下 2 桁で扱えること
- 不正フォーマット（必須項目欠落、日付形式不正、工数が数値でない）を検出し、エラーメッセージを表示すること
- 未登録プロジェクトを検出し、警告表示すること
- プロジェクト名でマッピングし、消化工数を集計できること

**関連要求**
- STK-003

**備考**
- 日付フォーマットは `YYYY/MM/DD` のみ対応
- メンバー名のマスタ管理は不要

#### REQ-F-003: 休日マスタの JSON インポート
**概要**
休日マスタ JSON ファイルを読み込み、営業日カレンダーを管理する。

**詳細**
- 入力: JSON ファイル（フォーマット: `{"YYYY-MM": {"DD": 0 or 1, ...}, ...}`, 休日 = 0、業務日 = 1）
- 出力: 営業日カレンダーのデータモデルへの格納
- 処理:
  - JSON ファイルをアップロードまたは指定パスから読み込む
  - フォーマットバリデーション（年月キー形式、日キー形式、値が 0 または 1）
  - データベース / データストアへの格納
- 例外処理:
  - 不正フォーマット検出時はエラーメッセージを表示し、取り込みを中止

**受入条件**
- JSON ファイル（フォーマット: `{"YYYY-MM": {"DD": 0 or 1, ...}, ...}`）を読み込み可能であること
- 不正フォーマット（年月キー形式不正、日キー形式不正、値が 0 または 1 以外）を検出し、エラーメッセージを表示すること
- 正常なデータのみをデータストアに格納すること

**関連要求**
- STK-005

**備考**
- JSON フォーマット: 年月キーは `YYYY-MM` 形式（例: `2025-01`）、日キーは `DD` 形式（例: `01`, `31`）、値は 0（休日）または 1（業務日）
- JSON Schema:
  ```json
  {
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Monthly Workday Schema",
    "type": "object",
    "patternProperties": {
      "^[0-9]{4}-(0[1-9]|1[0-2])$": {
        "type": "object",
        "patternProperties": {
          "^(0[1-9]|[12][0-9]|3[01])$": {
            "type": "integer",
            "enum": [0, 1],
            "description": "0 = Saturday/Sunday, 1 = Weekday"
          }
        },
        "additionalProperties": false
      }
    },
    "additionalProperties": false
  }
  ```

#### REQ-F-004: プロジェクト一覧画面の表示
**概要**
複数プロジェクトの工数消化状況を一覧表示し、問題の有無を迅速に判断できるようにする。

**詳細**
- 入力: プロジェクト契約情報、工数実績データ
- 出力: プロジェクト一覧画面（各プロジェクトの消化率、状態を視覚的に表示）
- 処理:
  - プロジェクトごとの工数消化率を計算（消化済み工数 / 契約工数）
  - 問題のあるプロジェクト（消化遅延・余剰）を識別（基準は要確認）
  - 一覧表示（プロジェクト名、契約工数、消化済み工数、消化率、状態など）
- 表示項目:
  - プロジェクト名
  - 業務開始日
  - 業務終了日
  - 契約工数
  - 消化済み工数
  - 消化率（%）
  - 状態（正常 / 遅延 / 余剰など、基準は要確認）

**受入条件**
- プロジェクト一覧画面から各プロジェクトの消化率が視覚的に判断できること
- 問題のあるプロジェクト（消化遅延・余剰）が識別可能であること（色分け、アイコン表示など）
- プロジェクト一覧から詳細画面への遷移が可能であること

**関連要求**
- STK-001

**備考**
- 消化遅延・余剰の判定基準（しきい値）: 理想線から ±5%
- 一覧画面のソート順、フィルタリング機能は不要

#### REQ-F-005: バーンダウンチャート形式での工数消化可視化
**概要**
プロジェクト詳細画面で、終了日までの残日数と工数消化状況をバーンダウンチャート形式で表示する。

**詳細**
- 入力: プロジェクト契約情報、工数実績データ、営業日カレンダー
- 出力: バーンダウンチャート（横軸: 営業日ベースの残日数、縦軸: 残工数）
- 処理:
  - 業務開始日から終了日までの営業日数を計算（休日マスタを考慮）
  - 理想線の計算（契約工数を営業日数で均等割り）
  - 実績線の計算（日次の工数実績を累積）
  - 現在日の位置をマーキング
  - チャート描画（理想線、実績線、現在日マーカー）
- 例外処理:
  - 営業日カレンダーが未登録の場合はカレンダー日数で代替（警告表示）

**受入条件**
- 横軸: 営業日ベースの残日数、縦軸: 残工数でチャートを表示すること
- 理想線（契約工数を営業日数で均等消化した線）と実績線を表示すること
- 現在日の位置が明確にわかること（マーカー、縦線など）
- 営業日カレンダーが未登録の場合はカレンダー日数で代替し、警告表示すること

**関連要求**
- STK-004, STK-005

**備考**
- チャートライブラリ: plotly
- 実績線の補間方法: 直線補間

#### REQ-F-006: 個人ごとの稼働状況可視化
**概要**
メンバー単位で工数使用状況を表示し、他業務従事や長期休暇の可能性を判断できるようにする。

**詳細**
- 入力: 工数実績データ、営業日カレンダー
- 出力: メンバー別稼働状況画面（期間内の工数使用量、複数プロジェクトへの配分状況、未稼働期間を表示）
- 処理:
  - メンバーごとの工数実績を集計（日次、週次、月次など、粒度は要確認）
  - 複数プロジェクトへの配分状況を可視化（積み上げ棒グラフなど、形式は要確認）
  - 未稼働期間の検出（工数実績がゼロの日を抽出）
  - 営業日カレンダーと照合し、営業日の未稼働を強調表示
- 表示項目:
  - メンバー名
  - 期間内の総工数
  - プロジェクト別配分状況
  - 未稼働期間
  - 未稼働理由候補（休日、長期休暇など、営業日カレンダーから推定）

**受入条件**
- メンバー単位で、期間内の工数使用量を表示できること
- 複数プロジェクトへの配分状況が確認できること
- 未稼働期間が視覚的にわかること（カレンダー表示、ヒートマップなど）

**関連要求**
- STK-006

**備考**
- 表示粒度: 月次
- 可視化形式: 積み上げ棒グラフ

#### REQ-F-007: 工数余剰要因の分析支援
**概要**
工数が余剰している場合、他業務従事や長期休暇などの要因を提示する。

**詳細**
- 入力: プロジェクト契約情報、工数実績データ、営業日カレンダー、メンバー稼働状況
- 出力: 工数余剰要因候補の提示（テキスト、アイコン、グラフなど、形式は要確認）
- 処理:
  - プロジェクトの工数余剰を検出（理想線と実績線の乖離、しきい値は要確認）
  - 該当プロジェクトのメンバー稼働状況を分析
  - 未稼働期間と営業日カレンダーを照合
  - 要因候補を推定（他プロジェクト従事、長期休暇、営業日の未稼働など）
  - 要因候補を画面に提示
- 要因候補の例:
  - メンバー A が他プロジェクト B に XX 時間使用
  - メンバー C が期間中 YY 日間未稼働（長期休暇の可能性）
  - 営業日の未稼働が ZZ 日間発生

**受入条件**
- メンバー稼働状況と休日カレンダーを組み合わせて要因候補を提示できること
- 要因候補の提示形式（テキスト、リスト、グラフなど）が視覚的にわかりやすいこと

**関連要求**
- STK-007

**備考**
- 工数余剰の検出基準: 正確な数値で検出（理想線と実績線の差分を表示）
- 要因候補の推定ロジック: 信頼度を表示

#### REQ-F-008: データファイルの再読み込み
**概要**
別ツールで編集した CSV / JSON ファイルを再取得し、データを更新する。

**詳細**
- 入力: 更新された CSV / JSON ファイル
- 出力: データストアの更新、画面の再表示
- 処理:
  - ユーザーが「再読み込み」ボタンをクリック
  - 指定パスまたはアップロードされたファイルを再読み込み
  - 既存データとの差分を検出（新規追加、更新、削除）
  - データストアを更新
  - 画面を再表示
- 例外処理:
  - ファイルが存在しない場合はエラーメッセージを表示
  - 不正フォーマット検出時はエラーメッセージを表示し、更新を中止

**受入条件**
- CSV / JSON ファイルを再読み込み可能であること
- 既存データとの差分を検出し、データストアを更新できること
- 更新後、画面が自動的に再表示されること

**関連要求**
- STK-002, STK-003, STK-005

**備考**
- 再読み込み時のデータ整合性: プロジェクトの削除はないが、予定工数は変更する可能性がある。メンバーも入力データが変わることがある。データの整合性は CSV データで上書き更新する

#### REQ-F-009: レポート機能（グラフと数値）
**概要**
経営層・PM 向けに、プロジェクトおよびメンバー稼働状況のレポートをグラフと数値の両方で表示する。

**詳細**
- 入力: プロジェクト契約情報、工数実績データ、営業日カレンダー
- 出力: レポート画面（グラフ、表形式の数値）
- 処理:
  - プロジェクト別の工数消化状況をグラフ化（バーンダウンチャート、円グラフなど、形式は要確認）
  - メンバー別の稼働状況をグラフ化（積み上げ棒グラフ、ヒートマップなど、形式は要確認）
  - 数値データを表形式で表示（プロジェクト名、契約工数、消化済み工数、消化率など）
  - レポートのエクスポート機能（PDF, Excel など、形式は要確認）
- 表示項目:
  - プロジェクト別工数消化状況（グラフ、数値）
  - メンバー別稼働状況（グラフ、数値）
  - 全体サマリ（総契約工数、総消化工数、平均消化率など）

**受入条件**
- プロジェクトおよびメンバー稼働状況のレポートをグラフと数値の両方で表示できること
- レポートの表示形式が視覚的にわかりやすいこと
- レポートのエクスポート機能があること（形式は要確認）

**関連要求**
- STK-001, STK-006

**備考**
- レポートのエクスポート形式: CSV または JSON
- レポートの表示項目: 各プロジェクトの残工数（利益）、個人の負荷率

## 4. Non-Functional Requirements

### 4.1 パフォーマンス
#### REQ-NF-001: データ読み込み時間
**概要**
CSV / JSON ファイルの読み込み時間は、ファイルサイズに応じて許容範囲内であること。

**詳細**
- プロジェクト契約情報 CSV（想定行数: 50 件）の読み込み時間は 5 秒以内
- 工数実績データ CSV（想定行数: 5000 件）の読み込み時間は 10 秒以内
- 休日マスタ JSON（想定年数: 10 年）の読み込み時間は 3 秒以内

**受入条件**
- 上記の想定ファイルサイズにおいて、読み込み時間が基準値以内であること
- 読み込み中はプログレスバーまたはローディングアニメーションを表示すること

**関連要求**
- STK-001, STK-002, STK-003, STK-005

**備考**
- 想定行数・年数: プロジェクト数 50 件、工数実績行数 5000 件、休日マスタ年数 10 年
- パフォーマンス測定環境: 業務用ノート PC

#### REQ-NF-002: チャート描画時間
**概要**
バーンダウンチャート、メンバー稼働状況グラフの描画時間は、ユーザー体験を損なわない範囲であること。

**詳細**
- バーンダウンチャートの描画時間は 3 秒以内
- メンバー稼働状況グラフの描画時間は 5 秒以内

**受入条件**
- 上記の描画時間が基準値以内であること
- 描画中はプログレスバーまたはローディングアニメーションを表示すること

**関連要求**
- STK-004, STK-006

**備考**
- パフォーマンス測定環境: 業務用ノート PC

### 4.2 ユーザビリティ
#### REQ-NF-003: 操作性
**概要**
ユーザーが直感的に操作できる UI を提供すること。

**詳細**
- ファイルの読み込みは、ドラッグ&ドロップまたはファイル選択ダイアログで可能
- プロジェクト一覧から詳細画面への遷移はワンクリック
- エラーメッセージは、問題の内容と対処方法を明確に提示
- グラフはインタラクティブ（ズーム、ホバー時の数値表示など、詳細は要確認）

**受入条件**
- ユーザーが操作マニュアルなしで基本操作を実行できること
- エラー発生時に、問題の内容と対処方法が明確に表示されること

**関連要求**
- STK-001, STK-002, STK-003, STK-004, STK-005, STK-006

**備考**
- UI デザインのモックアップは不要（標準的な UI で実装）
- グラフのインタラクティブ機能は不要

### 4.3 保守性
#### REQ-NF-004: コードの可読性と保守性
**概要**
コードは可読性が高く、将来の機能追加・変更が容易であること。

**詳細**
- PEP 8 スタイルガイドに準拠
- 関数・クラスには docstring を記述
- 単体テストのカバレッジは 80% 以上
- モジュール構成は責務ごとに分割

**受入条件**
- PEP 8 スタイルガイドに準拠していること
- 関数・クラスに docstring が記述されていること
- 単体テストのカバレッジが目標値以上であること

**関連要求**
- 全般

**備考**
- 単体テストのカバレッジ目標値: 80% 以上
- リンター / フォーマッタ: quality-fix コマンドに準拠

### 4.4 運用性
#### REQ-NF-005: エラーログの記録
**概要**
エラー発生時には、詳細なログを記録し、トラブルシューティングを支援すること。

**詳細**
- エラー発生時には、エラー内容、発生日時、スタックトレースをログファイルに記録
- ログファイルは、ユーザーが確認可能な場所に保存（保存場所は要確認）
- ログレベルは、DEBUG, INFO, WARNING, ERROR, CRITICAL の 5 段階

**受入条件**
- エラー発生時に、エラー内容、発生日時、スタックトレースがログファイルに記録されること
- ログファイルがユーザーが確認可能な場所に保存されること

**関連要求**
- 全般

**備考**
- ログファイルの保存場所: アプリケーションディレクトリ
- ログローテーション: 不要

#### REQ-NF-006: データバックアップ
**概要**
ユーザーがデータをバックアップできる機能を提供すること。

**詳細**
- データストア（データベースまたはファイル）のエクスポート機能を提供
- エクスポート形式: CSV または JSON
- バックアップファイルからのリストア機能を提供

**受入条件**
- データストアをエクスポートできること
- バックアップファイルからリストアできること

**関連要求**
- STK-002, STK-003, STK-005

**備考**
- エクスポート形式: CSV または JSON
- リストア時のデータ整合性チェック: 不要

### 4.5 セキュリティ
#### REQ-NF-007: データの機密性
**概要**
工数実績データおよびプロジェクト契約情報は、ローカル PC 上で管理され、外部への送信は行わないこと。

**詳細**
- データはローカル PC 上のデータストアに保存
- 外部サーバーへのデータ送信は一切行わない
- データストアへのアクセスは、OS のファイルアクセス権限に従う

**受入条件**
- データがローカル PC 上のデータストアに保存されること
- 外部サーバーへのデータ送信が一切行われないこと

**関連要求**
- STK-002, STK-003

**備考**
- データストアの暗号化: 不要

### 4.6 可用性
#### REQ-NF-008: アプリケーションの安定性
**概要**
アプリケーションは、想定される操作において安定動作すること。

**詳細**
- 不正なファイルを読み込んでもクラッシュしないこと（エラーメッセージを表示し、正常復帰）
- メモリリークが発生しないこと
- 長時間稼働してもパフォーマンス劣化が発生しないこと（想定稼働時間: 1 日 30 分）

**受入条件**
- 不正なファイルを読み込んでもクラッシュせず、エラーメッセージを表示して正常復帰すること
- メモリリークが発生しないこと
- 想定稼働時間内でパフォーマンス劣化が発生しないこと

**関連要求**
- 全般

**備考**
- 想定稼働時間: 1 日 30 分
- メモリリーク検出ツール: quality-fix コマンドに準拠

## 5. Constraints
以下の制約は、01_stakeholder-needs.md の Constraints から継承し、システム要件レベルで補完したものである。

- **技術的制約**
  - データソースは CSV（工数実績、プロジェクト契約）および JSON（休日マスタ）のみ
  - Python (uv) 環境で動作すること
  - デスクトップアプリケーションとして動作（Web サーバー不要）
  - Python バージョン: 3.12
  - 使用可能なライブラリ: pandas, matplotlib, plotly, PySide6, Tkinter など（制限なし）
  - GUI フレームワーク: PySide6
  - データストア形式: SQLite

- **運用制約**
  - データ更新頻度: 日次
  - 配布形態: 各ローカル PC で単独実行（マルチユーザー同時接続は不要）
  - 入力データの編集は別ツールで行い、編集後のファイルを再取得する
  - インストール方法: uv コマンド

- **外部依存**
  - 外部サービスから工数実績 CSV を日次でエクスポート可能であること
  - 休日マスタを JSON 形式で提供可能であること
  - 外部サービスの仕様変更時には、本システムも対応が必要

## 6. Open Questions

None

## 7. Appendix

### 要求 → 要件のマッピング表

| Stakeholder Need ID | System Requirement ID | 備考 |
|---------------------|-----------------------|------|
| STK-001 | REQ-F-004, REQ-F-009 | プロジェクト一覧画面、レポート機能 |
| STK-002 | REQ-F-001, REQ-F-008 | プロジェクト契約情報の CSV インポート、再読み込み |
| STK-003 | REQ-F-002, REQ-F-008 | 工数実績データの CSV インポート、再読み込み |
| STK-004 | REQ-F-005 | バーンダウンチャート形式での工数消化可視化 |
| STK-005 | REQ-F-003, REQ-F-005, REQ-F-008 | 休日マスタの JSON インポート、営業日カレンダーの考慮、再読み込み |
| STK-006 | REQ-F-006, REQ-F-009 | 個人ごとの稼働状況可視化、レポート機能 |
| STK-007 | REQ-F-007 | 工数余剰要因の分析支援 |

### メモ・補足
- 本ドキュメントは、01_stakeholder-needs.md をもとに作成した。
- 全ての Open Questions が解消され、要件定義は凍結状態となった。
- 確定した主要項目:
  - CSV / JSON のフォーマット詳細（日付形式、キー形式など）
  - 判定基準（消化遅延・余剰のしきい値: ±5%）
  - UI デザイン（標準的な UI、可視化形式: plotly、積み上げ棒グラフなど）
  - 技術スタック（Python 3.12、PySide6、SQLite、plotly など）
- 次フェーズ: 設計フェーズへ移行
