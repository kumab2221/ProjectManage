# 3. システム設計フェーズ（C4モデルベース）

凍結された `docs/requirements/02_system-requirements.md` を出発点に、**システム全体の構成をC4モデルで可視化**し、システムレベルの設計判断を行うフェーズ。

このフェーズの成果物は `docs/design/00_system-design.md` であり、次フェーズ「4. アーキテクチャ検討」の入力となる。

---

## 前提条件

以下のファイルが完了・凍結していること。

- `docs/requirements/01_stakeholder-needs.md`（要求凍結済み）
- `docs/requirements/02_system-requirements.md`（要件凍結済み）
- Open Questions が完全に解消されていること

---

# STEP 1：System Design Draft（初回生成）

## 目標
要件定義のエッセンスを整理し、システム設計のドラフトを作成する。ここでは**システム全体の構造と境界を固定**することを優先する。

## 事前準備（必ず抜き出す）
1. **主要な機能要件（REQ-F）**
   - コア機能、外部連携（CSV/API/DB/ハードウェア）の有無
2. **重要な非機能要件（REQ-NF）**
   - Performance / Availability / Security / Usability / Operability など
3. **制約条件（Constraints）**
   - 技術スタック、配置環境（オンプレ/クラウド/エッジ）、運用形態
4. **外部アクター・外部システム**
   - ユーザー、他システム、ハードウェア機器、外部サービスなど

## 使うコマンド
`.claude/commands/system-design.md`

## Claude への持ち込み例

```claude
/system-design

docs/requirements/02_system-requirements.md を前提に、
システム設計書の Draft を生成してください。

【補足】
- クライアントPC上で動作するデスクトップアプリ
- 外部システム：なし（CSVファイル入力のみ）
- DB：SQLite（ローカル）
```

## Draft の特徴
- System Context（外部アクター・外部システムとの関係）が明確
- Container図（サブシステム・コンポーネント構成）が一望できる
- 配置環境・実行環境が明示される
- 品質特性・制約が整理される
- データフローの概要が記述される

## 生成されるファイル
`docs/design/00_system-design.md`

テンプレート構造：

```
1. Overview                    ─ システムの目的、スコープ、関連ドキュメント
2. System Context              ─ C4レベル1：外部アクター・外部システム・Context図
3. Quality Attributes & Constraints ─ 非機能要件・制約
4. Logical Architecture        ─ C4レベル2：Container図、各コンテナの役割
5. Execution / Deployment View ─ 実行環境・配置構成
6. Integration & Data Flow     ─ 外部連携・データフロー
7. Mapping to Requirements     ─ REQ-F / REQ-NF への対応マトリクス
8. Risks & Future              ─ システムレベルのリスク・将来方針
```

---

# STEP 2：System Design Refine（詳細化と追記のループ）

## 目標
Draft で浮き彫りになったギャップを埋め、**システム構成を具体化しアーキテクチャ検討に直結する粒度**に磨き上げる。

## ループの流れ
1. Draft の「8. Risks & Future」と「7. Mapping to Requirements」を読み、足りない観点を洗い出す
2. 追記・修正したい指示をメモ化（外部システム連携の詳細、配置図の追加など）
3. `/system-design <memo>` を再実行して `00_system-design.md` を再生成
4. 生成結果をレビューして差分を検証
5. まだ曖昧さが残る場合はメモを更新し、再び 3 に戻る

## Claude への持ち込み例

```claude
/system-design memo_system_notes.txt
```

`memo_system_notes.txt` の例：
- System Context 図に「管理者アクター」を追加
- Container 図に「ログ収集コンポーネント」を追加
- Quality Attributes に「データバックアップ方針」を追記
- Deployment View に「ネットワーク構成図」を追加

## Refine のチェックポイント
- System Context 図が**すべての外部アクター・外部システム**を含んでいる
- Container 図が**すべてのサブシステム・コンポーネント**を含んでいる
- 品質特性が**定量的な基準**を持つ（応答時間、稼働率など）
- データフローが**エンドツーエンド**で追跡可能
- 配置環境・実行環境が**具体的**に記述されている
- 「7. Mapping to Requirements」がすべての REQ-F / REQ-NF をカバーしている

---

# STEP 3：System Design Freeze（レビュー＆凍結宣言）

## 目標
`docs/design/00_system-design.md` をレビューし、**アーキテクチャ検討フェーズの唯一のインプット**として凍結する。

## レビューチェックリスト

### 3.1 System Context の妥当性
- [ ] すべての外部アクター（ユーザー、管理者、外部システム、ハードウェア）が列挙されている
- [ ] System Context 図が明確で、信頼境界（Trust Boundary）が明示されている
- [ ] 外部システムとのインターフェース方式（API、ファイル連携など）が明記されている

### 3.2 Container の具体性
- [ ] すべてのサブシステム・コンポーネントが Container 図に含まれている
- [ ] 各コンテナの役割・責務が明確
- [ ] 技術スタック（言語、FW、DB、インフラ）が具体的に記述されている

### 3.3 品質特性・制約の明確性
- [ ] 品質特性が数値・条件で定義されている（応答時間、稼働率など）
- [ ] プラットフォーム制約（OS、ランタイム、DB）が明記されている
- [ ] 組織・運用上の制約が現実的で、実現可能

### 3.4 配置・実行環境の具体性
- [ ] 実行環境（クライアント、サーバー、クラウド、エッジ）が明確
- [ ] プロセス構成、サービス間通信が記述されている
- [ ] ネットワーク構成、セキュリティ境界が明示されている（必要に応じて）

### 3.5 要件との整合性
- [ ] すべての REQ-F / REQ-NF が「7. Mapping to Requirements」でカバーされている
- [ ] 未対応・グレーな要件が明示され、理由が記述されている

### 3.6 リスク・将来方針
- [ ] システムレベルのリスク（SPOF、スケーラビリティ限界など）が明記されている
- [ ] 将来の拡張方針（マイクロサービス化、クラウド移行など）が記述されている

## 修正依頼テンプレート

```claude
docs/design/00_system-design.md をレビューしました。
以下の点を修正してください。

- System Context 図に「外部API連携」を追加
- Container 図の「バッチ処理コンポーネント」の役割を明確化
- Quality Attributes の「Performance」を数値化（応答時間 3 秒以内）
- Deployment View にネットワーク構成図を追加
```

## 凍結宣言テンプレート

```claude
docs/design/00_system-design.md のレビューが完了しました。
内容は妥当で、アーキテクチャ検討フェーズに進む準備が整っています。

以降、このファイルを前提としてアーキテクチャ検討フェーズに進んでください。
```

---

# 全体フロー

```
STEP 1：System Design Draft
  ↓ 02_system-requirements.md から情報を抽出
STEP 2：System Design Refine（ループ）
  ↓ /system-design で再生成・差分吸収
STEP 3：System Design Freeze
  ↓ 凍結宣言 → アーキテクチャ検討フェーズへ
```

---

## 重要な注意事項

### システム設計とソフトウェアアーキテクチャの切り分け
- 本フェーズは **システム全体の構造と境界**（C4レベル1〜2）を扱う
- **ソフトウェアアーキテクチャ（レイヤード、DDD等）の詳細検討**は次フェーズ「4. アーキテクチャ検討」で行う
- `00_system-design.md` は **システムレベルの全体像** を記録し、個別のソフトウェア設計パターンは次フェーズで扱う

### C4モデルの適用範囲
- **レベル1（System Context）**：システムと外部アクター・外部システムの関係
- **レベル2（Container）**：サブシステム・コンポーネント構成
- **レベル3（Component）以降**：次フェーズ「6. ソフトウェア設計」で詳細化

### 単体アプリの場合
- 外部システムがない場合でも、System Context 図で**システム境界**を明示する
- Container 図で**アプリケーション内部の構成**（UI、ビジネスロジック、DB）を可視化する
- これにより、設計の抜け漏れを防ぎ、後続フェーズへの橋渡しを確実にする

### 要件定義との整合
- `02_system-requirements.md` に存在しない要件を前提にしない
- REQ-F / REQ-NF / STK ID を正確に参照する
- 曖昧さが残る場合は要件定義フェーズに戻って解消する

### 成果物
- `docs/design/00_system-design.md`（凍結済み）
  - 次フェーズ「4. アーキテクチャ検討」の唯一の入力
