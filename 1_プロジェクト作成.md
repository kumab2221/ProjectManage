# 1. プロジェクト作成（Claude Code 前提）

## 1.1 目的
- Claude Code と MCP（Context7 / filesystem / git / exec / text-analysis）を前提にした開発プロジェクトの初期セットアップを標準化する。
- どのプロジェクトでも本章の手順を完了すれば、後続フェーズ（要件定義 → 設計 → ADR → 実装 → テスト）を再現性と品質を維持しながら進められる状態にする。

---

## 1.2 手順概要

1. プロジェクトディレクトリの作成
2. Python 仮想環境（uv）＋ 基本品質ツール（ruff / mypy / pytest）の導入
3. Git 初期化（main ブランチを確定）
4. ベースディレクトリ構成の作成＋ src-layout への統一
5. Claude Code 初期化
6. ベース MCP の追加（Context7 / filesystem / git / exec / text-analysis）
7. Claude.md（プロジェクト記憶）の作成
8. カスタムコマンド（`.claude/commands/*.md`）の作成

---

## 1.3 プロジェクトディレクトリ作成

```sh
mkdir <project>
cd <project>
```

- `<project>` はリポジトリ名・Claude Code の Project name と一致させる。

---

## 1.4 仮想環境の追加（Python / uv）

本プロジェクトでは **src-layout（src/ 配下にコードを配置）** を必須とするため、
uv init が生成する main.py は後で移動する。

```sh
uv init .
uv add --dev ruff mypy pytest lizard
```

- `uv init .` で `pyproject.toml` と仮想環境を作成する。
- `ruff` と `mypy` は標準の品質チェックツールとして必須とする。

### なぜ pytest をこの段階で入れるのか？
- **TDD / BDD を初期から可能にするため**
- CI/CD 構成（GitHub Actions / Jenkins）と整合性が取れるため
- Claude Code の `implement-file.md` でテスト自動生成を行うため

---

## 1.5 Git 初期化

```sh
git init .
git branch -M main
```

- `.gitignore` は uv + Python 専用の推奨設定を使用する。
- main ブランチは常に「動作保証状態」とし、CI/CD はこの前提で構成する。

---

## 1.6 ベースディレクトリ構成

（src-layout + ドキュメントテンプレ構造と完全整合）
uv init により `main.py` がプロジェクト直下に生成されるため、**src-layout** に統一する。

```sh
mkdir -p src tests
mkdir -p docs/requirements docs/design
mkdir -p ADR
mkdir -p plans
mkdir -p docs/release-notes
mkdir -p .github/workflows
mkdir -p .claude/commands

mv main.py src/main.py
```

### なぜ src-layout が必須なのか？
- Python の推奨構造（PyPA 標準）
- CI（pytest / ruff / mypy）が安定する
- Claude Code がファイル参照する際のパスブレを防止
- 将来的なパッケージ化にも対応可能
- テストと実装のディレクトリを明確にセパレートするため

### ディレクトリごとの役割（後工程との整合性を明記）

| ディレクトリ | 役割 |
|--------------|------|
| src/ | アプリケーション本体（すべてのコードはここに置く） |
| tests/ | pytest による自動テスト群 |
| docs/requirements/ | 01, 02, 03, 04 の要求/要件/文脈テンプレ文書 |
| docs/design/ | 設計書（UI/ドメイン/インターフェース） |
| ADR/ | Architecture Decision Record（設計判断の履歴） |
| plans/ | 機能別実装計画（フィーチャー分解） |
| docs/release-notes/ | リリースノート自動生成の保管場所 |
| .github/workflows/ | GitHub Actions（CI/CD） |
| .claude/commands/ | Claude Code のカスタムコマンド定義 |

### 注意（見出し構造保護との整合性）
docs/requirements の文書（01, 02）は
**Claude.md により見出し構造固定を強制できる前提**
で運営される。

---

## 1.7 Claude Code 初期化

Claude Code 上で当該プロジェクトを開き、以下を実行する。

```claude
/init
```

### この工程の目的
- この瞬間から、このディレクトリが **Claude Code にとっての正式な "Project context"** になる。
- 以降の会話・生成物はすべて **Project memory（Claude.md）に基づく** 振る舞いに変わる。
- Claude がプロジェクト単位で「仕様 → 設計 → ADR → コード → テスト」を一貫処理できる環境がここで初期化される。

### 注意（絶対遵守）
- `/init` 前にファイル生成を依頼すると、Claude が文脈を誤認してテンプレ構造が壊れる可能性がある。
- `/init` は **MCP 導入より先に実行する**。
  （MCP がプロジェクトに紐づかない不整合を防止）

---

## 1.8 MCP 標準構成（Claude Code プロジェクト用）
（Context7 / filesystem  — scope=project）

### 1.8.1 目的

本プロジェクトの開発フロー（要件 → 設計 → ADR → 実装 → テスト）において、Claude Code が次の 2 つの能力を持つことを保証する：

| MCP 名（Claude 内名称） | パッケージ名（公式）                                  | 目的 |
|------------------------|------------------------------------------------------|------|
| filesystem             | @modelcontextprotocol/server-filesystem              | ファイル操作（生成・更新・削除・探索） |
| context7               | @upstash/context7-mcp                                | ドキュメント/API仕様参照（Upstash） |

※ modelcontextprotocol/* は MCP 公式 Reference Server。
※ context7 は Upstash が提供する唯一の "AI対応ドキュメントレイヤ MCP" のため例外採用。


---

### 1.8.2 スコープと前提（ここを間違えると全て壊れる）

Claude CLI の `-s` / `--scope` は **「スコープ指定」** であり、
**プロジェクト名ではない**。

利用可能なスコープは以下のみ：

- `local`
- `user`
- `project`
- `dynamic`
- `enterprise`

本プロジェクトでは、
**「このリポジトリ専用の MCP 構成」** を作るため、
すべて **`-s project`（project scope）** で登録する。

> `-s profit_trace` のように **任意の文字列を指定することはできない**。
> `Invalid scope: xxx` エラーになるのは仕様通り。

---

### 1.8.3 MCP 追加手順（必須 2 種）

Claude Code は OS によって MCP サーバを起動する方法が異なる。
特に **Windows 版 Claude Code は `npx` を直接呼び出せない仕様**のため、
`cmd /c` を前置して **必ず cmd.exe 経由で npx を起動させる必要がある**。

| OS | npx 実行可否 | 必要な対処 | 例 |
|----|--------------|------------|-----|
| **Windows** | ✗（Claude Code では直接不可） | `cmd /c` を前置する | `cmd /c npx @modelcontextprotocol/server-filesystem` |
| **Linux / macOS** | ○（そのまま動作） | 対処不要 | `npx @modelcontextprotocol/server-filesystem` |

---

#### 共通構文

```sh
claude mcp add <name> -s project -- <commandOrUrl>
```

- `<name>`: Claude から見える MCP 名（例: `context7`, `filesystem` など）
- `-s project`: 「このプロジェクト用の MCP」として登録する
- `<commandOrUrl>`: MCP サーバを起動するためのコマンド or URL
  （各 MCP ごとに異なる。公式 README の指示に従うこと）

---

#### 1.8.3.1 Context7 MCP（ドキュメント参照）

#### Linux / macOS

```sh
claude mcp add context7 -s project -- npx @upstash/context7-mcp --api-key YOUR_API_KEY
```

#### Windows
Windowsの場合は`--api-key`を認識しないので、まずは下記を記載し、直接.mcp.jsonファイルを編集する

```sh
claude mcp add context7 -s project -- cmd /c npx @upstash/context7-mcp
```
[https://context7.com/](https://context7.com/)からAPI KEYを取得する
```json
"context7": {
      "type": "stdio",
      "command": "cmd",
      "args": [
        "/c",
        "npx",
        "@upstash/context7-mcp",
        "--api-key",
        "XXXXX"
      ],
      "env": {}
    }
```

用途：
- Python / Node / Rust / C# など公式ドキュメント参照
- API 仕様の正確な参照
- 設計判断の精度向上
- ADR の合理性裏付け

---

#### 1.8.3.2 filesystem MCP（ファイル操作）

#### Linux / macOS

```sh
claude mcp add filesystem -s project -- npx @modelcontextprotocol/server-filesystem
```

#### Windows
（実際に失敗していた部分。原因は Windows 版 Claude Code では npx が直接動かないため）

```sh
claude mcp add filesystem -s project -- cmd /c npx @modelcontextprotocol/server-filesystem
```

用途：
- `docs/requirements/` や `docs/design/`、`ADR/` のファイル自動生成
- `src/` のコード生成・更新
- 差分パッチ適用

---

### 1.8.4 MCP 設定確認（必須）

```sh
claude mcp list
```

以下 2 種が揃っていれば正しく導入されている：

- context7
- filesystem

1 つでも欠けていれば、該当 MCP の `<commandOrUrl>` 指定が誤っている可能性が高い。

---

### 1.8.5 MCP 導入後の初期動作チェック

#### filesystem の動作確認

```claude
docs/requirements/test.md を作成し、
内容を「MCP OK」という 1 行だけにしてください。
```

#### context7 の動作確認

```claude
Python の requests ライブラリの最新仕様を context7 で参照し、
要点を箇条書きでまとめてください。use context7
```

---

### 1.8.6 MCP フェーズの終了条件

以下の条件をすべて満たした場合、このフェーズを完了とする：

- `claude mcp list` に 2 種（context7 / filesystem ）が表示されている
- 各 MCP で最低 1 回の操作（ファイル操作 / 仕様参照）が成功している
- Claude Code が
  「要件整理 → 要件定義 → 設計 → ADR → 実装 → テスト」
  を実行可能な最低限の基盤を満たしている

---

## 1.9 ベースメモリ（Claude.md）作成

プロジェクトの前提・ルール・構造をまとめた `Claude.md` をプロジェクトルートに作成する。

テンプレート例：

````markdown
# Project memory

このファイルは Claude Code の振る舞いを制御するための **プロジェクト仕様** である。
本プロジェクトにおいて Claude は、ここに定められた規則を常に守らなければならない。

---

# 1. Project Overview
- Project name: <project>
- Purpose: <1〜3行>
- Primary language: Python (uv)
- Entrypoint: src/main.py

---

# 2. Document Templates (Structural Integrity Rules)

以下のドキュメントは **見出し構造が完全固定** であり、
Claude は、**追記以外の変更（削除 / 並び替え / 統合 / 分解 / 改名）を一切行ってはならない**。

## 2.1 01_stakeholder-needs.md の構造（固定）
```
# 01. Stakeholder Needs
## 1. Purpose
## 2. Scope
### 2.1 In Scope
### 2.2 Out of Scope
## 3. Stakeholder List
## 4. Stakeholder Needs
### 4.x <Stakeholder Name>
#### STK-xxx: <Title>
## 5. Constraints
## 6. Assumptions
## 7. Open Questions
## 8. Appendix
```

## 2.2 02_system-requirements.md の構造（固定）
```
# 02. System Requirements
## 1. Overview
## 2. Definitions
## 3. Functional Requirements
### 3.1 構成方針
### 3.2 要件一覧
#### REQ-F-xxx: <Title>
## 4. Non-Functional Requirements
#### REQ-NF-xxx: <Title>
## 5. Constraints
## 6. Open Questions
## 7. Appendix
```

### 【重要】
Claude がこれらに触れるときは、
**・追記は許可
・既存見出しの削除は禁止
・既存見出しの名称変更は禁止
・既存見出しの階層変更は禁止
・新しい章の追加は禁止（Appendix 内は可）
・内容の書き換えは Claude が明確な理由（要件反映）がある場合のみ許可**
とする。

---

# 3. Repository Layout
- src/
- tests/
- docs/requirements/
- docs/design/
- ADR/
- plans/
- docs/release-notes/

---

# 4. Process Rules
- 開発フロー：要件 → 設計 → ADR → 実装 → テスト
- 要件・設計の前に、必ず docs/requirements を参照する
- 重要な判断は必ず ADR に記録する
- main ブランチは常に動作保証状態とする

---

# 5. Claude Usage Policy (行動規範)

Claude は以下の行動規範に従う。

## 5.1 テンプレ遵守ルール（最重要）
- 固定テンプレ構造を **絶対に変更してはならない**
- 見出し構造を "省略して要約" する行為も禁止
- 「別の構造のほうがよい」などの提案は Appendix へ書くが、構造自体は変えない
- 要件追加は **既存の適切な見出しの下に追記** のみ許可

## 5.2 ドキュメント編集ルール
- 編集前に該当 doc の全文を読み込む
- 差分パッチ形式での変更を優先する
- 変更理由を説明する（例：STK-xxx との整合性）

## 5.3 技術ドキュメントの一貫性
- STK-xxx → REQ-F/REQ-NF のトレーサビリティを維持する
- 不確実性は Open Questions に送る（埋めない）

---

# 6. MCP Usage Rules
- context7：公式ドキュメント参照に使用
- filesystem：Markdown ドキュメントの自動編集
---

# 7. 禁止事項
Claude は **以下の行為を禁止** される。

- ドキュメント構造（見出し）の変更
- 章タイトルの変更
- 階層構造の変更
- 分割/統合による章の再構成
- 任意の新章追加（Appendix 以外）
- テンプレの自動要約や省略

---

# 8. Development Principles
- 情報不足は "補完しない"。Open Questions に送る。
- 数値の省略禁止（例：「高速」→ "500ms 以下" 提案）
- 曖昧表現禁止

---

# 9. Appendix
必要なら補足を追加する。
````

---

## 1.10 カスタムコマンド追加（`.claude/commands`）

### 1.10.1 目的

- Claude Code のコマンドパレットから、頻出の作業（要件整理・設計生成・プラン作成・実装・品質チェック・リリースノート作成・CI設定）を一貫した形で呼び出せるようにする。
- チーム全体で同じプロンプト・同じフローを共有し、再現性のある開発プロセスを確立する。

---

### 1.10.2 カスタムコマンド作成方法

カスタムコマンドは **`.claude/commands/*.md`** として保存する。

作成依頼例：

```claude
要求整理テンプレートを
.claude/commands/requirements-draft.md に作成してください。
```

Claude 再起動後、`requirements-draft` コマンドとして利用可能になる。

---

### 1.10.3 ベースコマンド一覧

初期セットアップで、以下のコマンドを用意する。
**各コマンドの詳細は `Commands/` ディレクトリ内のファイルを参照すること。**

#### 必須（要件〜実装〜品質）

| # | コマンド名 | 説明 | ファイル参照 |
|---|-----------|------|-------------|
| 1 | requirements-draft | ヒアリングメモから `01_stakeholder-needs.md` のドラフトを生成 | [Commands/requirements-draft.md](Commands/requirements-draft.md) |
| 2 | requirements-refine | `01_stakeholder-needs.md` の Open Questions を解消 | [Commands/requirements-refine.md](Commands/requirements-refine.md) |
| 3 | requirements-definition | ステークホルダー要求から `02_system-requirements.md` を生成 | [Commands/requirements-definition.md](Commands/requirements-definition.md) |
| 4 | requirements-definition-refine | `02_system-requirements.md` の Open Questions を解消 | [Commands/requirements-definition-refine.md](Commands/requirements-definition-refine.md) |
| 5 | architecture-decision | 要件定義からアーキテクチャ候補を検討・評価 | [Commands/architecture-decision.md](Commands/architecture-decision.md) |
| 6 | adr-create | 設計判断について ADR ファイルを生成 | [Commands/adr-create.md](Commands/adr-create.md) |
| 7 | design-from-requirements | 要件定義と ADR から設計書を生成 | [Commands/design-from-requirements.md](Commands/design-from-requirements.md) |
| 8 | create-plan | 機能単位の実装計画を生成 | [Commands/create-plan.md](Commands/create-plan.md) |
| 9 | implement-file | 要件とプランからコードとテストを生成・更新 | [Commands/implement-file.md](Commands/implement-file.md) |
| 10 | quality-fix | ruff / mypy / pytest を用いた品質チェックと修正 | [Commands/quality-fix.md](Commands/quality-fix.md) |
| 11 | refactor | コードのリファクタリング（責務分割・命名改善等） | [Commands/refactor.md](Commands/refactor.md) |
| 12 | release-notes | Git 履歴からリリースノートを自動生成 | [Commands/release-notes.md](Commands/release-notes.md) |
| 13 | ci-cd-setup | CI/CD 設定ファイル（Jenkinsfile / GitHub Actions）を生成 | [Commands/ci-cd-setup.md](Commands/ci-cd-setup.md) |

---

#### カスタムコマンドの使用方法

1. **コマンド作成**：上記ファイルの内容を `.claude/commands/<コマンド名>.md` にコピーする
2. **Claude 再起動**：Claude Code を再起動してコマンドを認識させる
3. **コマンド実行**：Claude のコマンドパレットから該当コマンドを実行する

詳細な仕様と使用方法は、各ファイルを参照してください。
