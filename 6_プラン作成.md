# 6. 実装計画（プラン）作成フェーズ

設計書（docs/design/*.md）と ADR を前提に、
**実装可能な粒度のタスク一覧とスケジュール** を生成するフェーズ。

このフェーズでは、設計書の内容を
「実装者が迷わず作業を進められるレベルの実装計画」に落とし込む。

---

## 前提条件

以下のファイルが完成していること：

- ✅ `docs/requirements/02_system-requirements.md`（要件凍結済み）
- ✅ `ADR/ADR-XXX-*.md`（設計判断記録済み、Status: Accepted）
- ✅ `docs/design/*.md`（設計書完成済み）

---

# STEP 1：プラン作成の準備

## 目的
設計書を確認し、どの機能について実装計画を作成するかを決定する。

## 確認事項

`docs/design/` ディレクトリ内の設計書から、以下の情報を抽出する：

1. **実装対象機能の特定**
   - 設計書に記載された機能一覧
   - 機能の優先度（MUST / SHOULD / COULD）
   - 関連する REQ-F / REQ-NF

2. **機能の分割方針**
   - 大きな機能は複数のプランに分割するか
   - 1 プラン = 1 機能 の原則を守る

3. **実装の依存関係**
   - 先行して実装すべき機能
   - 並行実装可能な機能

## プラン作成の単位

**1 プラン = 1 機能**

以下のような機能単位でプランを作成する：

- **CSV インポート機能** → `plans/feature-csv-import.md`
- **チャート表示機能** → `plans/feature-chart-display.md`
- **設定管理機能** → `plans/feature-settings-management.md`

機能が大きすぎる場合は、サブ機能に分割する：

- **CSV インポート機能（基本）** → `plans/feature-csv-import-basic.md`
- **CSV インポート機能（高度）** → `plans/feature-csv-import-advanced.md`

---

# STEP 2：プランの生成

## 目的
決定した機能について、実装計画ファイルを生成する。

## 使うコマンド
`.claude/commands/create-plan.md`（または `Commands/create-plan.md` を参照）

## Claude への指示例

### 単一機能のプランを作成する場合

```claude
/create-plan

docs/design/*.md と ADR ディレクトリ内の全 ADR を参照し、
「CSV インポート機能」の実装計画を作成してください。

対象機能：CSV インポート機能
優先度：MUST
関連設計書：
- docs/design/02_domain-design.md
- docs/design/03_infrastructure-design.md
- docs/design/04_interface-design.md

出力先：plans/feature-csv-import.md
```

### 複数機能のプランを一括作成する場合

```claude
/create-plan

docs/design/*.md と ADR ディレクトリ内の全 ADR を参照し、
以下の機能について実装計画を作成してください：

1. CSV インポート機能（plans/feature-csv-import.md）
2. チャート表示機能（plans/feature-chart-display.md）
3. 設定管理機能（plans/feature-settings-management.md）

各プランは「1〜2 時間粒度のタスク分解」を守り、
実装者が迷わないレベルの詳細度を目指してください。
```

## このステップで生成されるファイル

`plans/feature-<機能名>.md`

以下の構造で出力される：

```markdown
# Feature Plan: <機能名>

## 1. Background（背景）
### 1.1 概要
### 1.2 関連ドキュメント

## 2. Objective（目的）

## 3. Scope（スコープ）
### 3.1 In Scope（含む）
### 3.2 Out of Scope（含まない）

## 4. Tasks（タスク一覧）
### 4.1 基盤タスク（Infrastructure / Domain）
### 4.2 アプリケーションタスク（Application）
### 4.3 プレゼンテーションタスク（Presentation）
### 4.4 テストタスク（Testing）

## 5. Estimation（見積もり）
### 5.1 タスク別見積もり
### 5.2 スケジュール目安

## 6. Dependencies（依存関係）
### 6.1 外部依存
### 6.2 内部依存

## 7. Risks（リスク/懸念点）
### 7.1 技術的リスク
### 7.2 仕様的リスク

## 8. Deliverables（成果物）
### 8.1 実装ファイル
### 8.2 テストファイル
### 8.3 ドキュメント

## 9. Acceptance Criteria（受入条件）

## 10. Notes（備考）
```

---

# STEP 3：プランのレビュー

## 目的
生成されたプランの内容を確認し、
タスク粒度・依存関係・リスクが適切かを検証する。

## レビューポイント

### 3.1 タスク粒度の妥当性
- [ ] 各タスクが **1〜2 時間** で完了する粒度に分解されているか
- [ ] 「CSV インポート機能の実装（8h）」のような粗いタスクがないか
- [ ] タスク粒度が細かすぎる（15 分未満）タスクがないか

### 3.2 タスクの具体性
- [ ] タスク名が具体的か（例：「CSV パーサーのクラス実装」）
- [ ] 成果物（ファイルパス）が明確に記載されているか
- [ ] 担当レイヤ（Presentation / Application / Domain / Infrastructure）が適切か

### 3.3 設計書との整合性
- [ ] `docs/design/*.md` に記載されたクラス名・メソッド名が正確に使用されているか
- [ ] 設計書に存在しない機能を勝手に追加していないか
- [ ] ADR の決定（例：レイヤ間の依存方向）を遵守しているか

### 3.4 依存関係の明確性
- [ ] 先行タスクが完了しないと着手できないタスクが「依存」列で明示されているか
- [ ] 外部依存（ライブラリ、ファイル、環境）が「6. Dependencies」で明示されているか
- [ ] 他のプラン・機能との依存関係が記述されているか

### 3.5 リスクの具体性
- [ ] リスクが具体的に記述されているか（「実装が難しい」のような抽象的な記述は NG）
- [ ] 各リスクに対して影響度が評価されているか
- [ ] 軽減策が具体的に提案されているか

### 3.6 受入条件の明確性
- [ ] 「9. Acceptance Criteria」が **チェックリスト形式** で記述されているか
- [ ] 曖昧な条件（「品質が良い」）ではなく、具体的な条件（「カバレッジ 80% 以上」）が記述されているか

## レビュー後の対応

### 修正が必要な場合

```claude
plans/feature-csv-import.md をレビューしました。
以下の点を修正してください：

- TASK-CSV-005 の粒度が粗い（8h → 2 時間以内のタスクに分割）
- 「6.1 外部依存」にライブラリのバージョン情報が欠けている
- 「7.1 技術的リスク」が抽象的（具体的なリスクと軽減策を記述）
- 「9. Acceptance Criteria」の条件が曖昧（数値基準を追加）
```

### 問題なければ承認

```claude
plans/feature-csv-import.md のレビューが完了しました。
内容は妥当で、実装フェーズに進む準備が整いました。

次のプラン（または次フェーズ）に進んでください。
```

---

# STEP 4：プランの完了宣言

## 目的
プラン作成フェーズの完了を明確にし、
次フェーズ（実装）への引き継ぎを行う。

## Claude への宣言（必須）

```claude
以下の実装計画が完成しました：

- plans/feature-csv-import.md
- plans/feature-chart-display.md
- plans/feature-settings-management.md

すべてのプランは設計書と ADR に基づいており、
タスク粒度は 1〜2 時間に分解されています。

実装フェーズに進む準備が整いました。
次のフェーズ「7. 実装」に進んでください。
```

---

# 全体フロー（プラン作成フェーズ）

```
STEP 1：プラン作成の準備
  ↓（設計書から機能を抽出、1 プラン = 1 機能）
STEP 2：プランの生成（create-plan コマンド）
  ↓（plans/feature-*.md 生成）
STEP 3：プランのレビュー
  ↓（タスク粒度・依存関係・リスク・受入条件を確認）
STEP 4：プランの完了宣言
  ↓
→ 次フェーズ「7. 実装」へ
```

---

## 重要な注意事項

### ⚠️ 1 プラン = 1 機能

- **複数の機能を 1 つのプランに詰め込まない**
- 「CSV インポート」「チャート表示」「設定管理」などは、それぞれ別プランに分ける
- 機能が大きい場合は、サブ機能に分割する

### ⚠️ タスク粒度を守る

- **各タスクは 1〜2 時間で完了する粒度に分解する**
- 「CSV インポート機能の実装（8h）」のような粗いタスクは NG
- 「CSV パーサーのクラス実装（1.5h）」のような具体的なタスクに分解する

### ⚠️ 設計書との整合性

- **`docs/design/*.md` に存在しない機能を勝手に追加しない**
- 設計書に記載されたクラス名・メソッド名を正確に使用する
- ADR の決定（例：レイヤ間の依存方向）を遵守する

### ⚠️ 依存関係を明確にする

- 先行タスクが完了しないと着手できないタスクは、「依存」列で明示する
- 外部依存（ライブラリ、ファイル、環境）を「6. Dependencies」で明示する
- 他のプラン・機能との依存関係を「6.2 内部依存」で明示する

### ⚠️ リスクを具体的に記述する

- 「実装が難しい」のような抽象的なリスクは NG
- 「大容量 CSV（10万行以上）の処理時間」のような具体的なリスクを記述する
- 各リスクに対して影響度と軽減策を記述する

### ⚠️ 受入条件を明確にする

- 「9. Acceptance Criteria」は **チェックリスト形式** で記述する
- 曖昧な条件（「品質が良い」）は避け、具体的な条件（「カバレッジ 80% 以上」）を記述する

---

## プラン作成のベストプラクティス

### レイヤごとにタスクを分解する

1. **Domain / Infrastructure**（基盤）
   - インターフェース定義
   - データモデル定義
   - リポジトリ実装
   - 外部連携実装

2. **Application**（ビジネスロジック）
   - サービス実装
   - ユースケース実装
   - バリデーション実装

3. **Presentation**（UI）
   - 画面実装
   - コントローラ実装
   - ViewModel 実装

4. **Testing**（テスト）
   - 単体テスト
   - 統合テスト
   - E2E テスト

### 見積もりの目安

- インターフェース定義：0.5〜1h
- クラス実装（小）：1〜2h
- クラス実装（中）：2〜4h（→ 2 時間以内に分割すること）
- UI 実装（画面 1 つ）：1.5〜3h（→ 2 時間以内に分割すること）
- 単体テスト（1 クラス）：0.5〜1.5h
- 統合テスト（1 ユースケース）：1〜2h

**IMPORTANT:** 2 時間を超えるタスクは、さらに細かいタスクに分割すること。

### タスク ID の命名規則

- 形式：`TASK-<機能略称>-<連番>`
- 例：`TASK-CSV-001`、`TASK-CHART-001`、`TASK-SETTINGS-001`
- 連番は 001 から開始し、レイヤごとに分ける必要はない

---

## 成果物

このフェーズ完了時点で、以下のファイルが完成している：

- ✅ `plans/feature-csv-import.md`（必要に応じて）
- ✅ `plans/feature-chart-display.md`（必要に応じて）
- ✅ `plans/feature-settings-management.md`（必要に応じて）
- ✅ ...（必要に応じて）

これらのプランは、次フェーズ「7. 実装」で参照され、
実装タスクの進捗管理と品質保証に使用される。

---

## プラン作成フェーズと実装フェーズの境界

プラン作成フェーズでは **「どのタスクを、どの順序で実装するか（What / When）」** を定義する。
実装フェーズでは **「具体的なコード（Code）」** を作成する。

プランは以下の粒度を目指す：

- ✅ タスクが 1〜2 時間粒度に分解されている
- ✅ 依存関係が明確
- ✅ リスクと軽減策が具体的
- ✅ 受入条件がチェックリスト形式で明確
- ❌ 具体的なコード（実装）は書かない
- ❌ ライブラリの詳細な使い方は書かない

実装者はプランを見て「迷わずタスクを進められる」状態を目指す。
